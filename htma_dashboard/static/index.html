<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>å¥½ç‰¹å–æ²ˆé˜³è¶…çº§ä»“è¿è¥çœ‹æ¿</title>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "PingFang SC", "Microsoft YaHei", sans-serif; background: #0f172a; color: #e2e8f0; min-height: 100vh; padding: 4px 8px; font-size: 0.85rem; }
    h1 { font-size: 1.05rem; margin-bottom: 1px; color: #f8fafc; }
    .subtitle { color: #64748b; font-size: 0.72rem; margin-bottom: 4px; }
    .kpi-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 4px; margin-bottom: 4px; }
    .kpi-card { background: linear-gradient(135deg, #1e293b 0%, #334155 100%); border-radius: 6px; padding: 8px 10px; border: 1px solid #334155; }
    .kpi-card .label { font-size: 0.7rem; color: #94a3b8; margin-bottom: 2px; }
    .kpi-card .value { font-size: 1.2rem; font-weight: 700; color: #38bdf8; }
    .kpi-card .value.warn { color: #fbbf24; }
    .kpi-card .value.danger { color: #f87171; }
    .section { background: #1e293b; border-radius: 6px; padding: 6px 8px; margin-bottom: 4px; border: 1px solid #334155; }
    .section h2 { font-size: 0.88rem; color: #94a3b8; margin-bottom: 4px; }
    .chart-row { display: grid; grid-template-columns: 1fr 1fr; gap: 4px; margin-bottom: 4px; }
    .chart-box { background: #1e293b; border-radius: 6px; padding: 6px 8px; border: 1px solid #334155; height: 280px; }
    .chart-box.chart-box-trend { height: 300px; }
    .chart-box h3 { font-size: 0.85rem; margin-bottom: 4px; color: #94a3b8; }
    .chart-box .chart { width: 100%; height: calc(100% - 22px); }
    .dashboard-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; margin-bottom: 6px; }
    .section.scroll-table { overflow: hidden; }
    .section.scroll-table .table-wrap { max-height: 180px; overflow-y: auto; }
    table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
    th, td { padding: 4px 8px; text-align: left; border-bottom: 1px solid #334155; }
    th { color: #94a3b8; font-weight: 600; }
    td { color: #e2e8f0; }
    tr:hover { background: #334155; }
    .num { text-align: right; font-variant-numeric: tabular-nums; }
    .loading { text-align: center; padding: 40px; color: #64748b; }
    .error { color: #f87171; padding: 12px; }
    .period-tabs { display: flex; align-items: center; gap: 4px; margin-bottom: 6px; flex-wrap: wrap; }
    .tab-label { color: #94a3b8; font-size: 0.9rem; }
    .tab-btn { padding: 4px 10px; border-radius: 6px; border: 1px solid #334155; background: #1e293b; color: #94a3b8; cursor: pointer; font-size: 0.8rem; }
    .tab-btn:hover { background: #334155; color: #e2e8f0; }
    .tab-btn.active { background: #38bdf8; color: #0f172a; border-color: #38bdf8; }
    .trend-section { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 4px; margin-bottom: 4px; }
    .trend-card { background: linear-gradient(135deg, #1e293b 0%, #334155 100%); border-radius: 6px; padding: 8px 10px; border: 1px solid #334155; }
    .trend-card h3 { font-size: 0.8rem; color: #94a3b8; margin-bottom: 4px; }
    .trend-item { display: flex; justify-content: space-between; padding: 3px 0; border-bottom: 1px solid #334155; font-size: 0.75rem; }
    .trend-item:last-child { border-bottom: none; }
    .trend-up { color: #34d399; }
    .trend-down { color: #f87171; }
    .trend-neutral { color: #94a3b8; }
    .chart-tabs { display: flex; gap: 6px; margin-bottom: 6px; }
    .chart-tabs .tab-btn { padding: 4px 12px; font-size: 0.85rem; }
    .filter-bar { display: flex; align-items: center; gap: 6px; margin-bottom: 4px; flex-wrap: wrap; }
    .filter-bar .period-tabs { display: flex; align-items: center; gap: 4px; margin: 0; }
    .filter-bar .date-range-inline { display: flex; align-items: center; gap: 4px; }
    .filter-sep { color: #475569; margin: 0 4px; font-size: 0.9rem; }
    .filter-bar label { color: #94a3b8; font-size: 0.9rem; }
    .filter-bar input[type="date"], .filter-bar select { padding: 6px 10px; border-radius: 6px; border: 1px solid #334155; background: #1e293b; color: #e2e8f0; font-size: 0.85rem; }
    .filter-bar select { min-width: 110px; cursor: pointer; }
    .filter-bar .btn-query { padding: 8px 20px; border-radius: 8px; border: none; background: #38bdf8; color: #0f172a; font-weight: 600; cursor: pointer; font-size: 0.9rem; }
    .filter-bar .btn-query:hover { background: #7dd3fc; }
    .export-btns { display: flex; gap: 8px; margin-left: auto; }
    .btn-export { padding: 6px 12px; border-radius: 6px; background: #334155; color: #38bdf8; text-decoration: none; font-size: 0.8rem; border: 1px solid #475569; }
    .btn-export:hover { background: #475569; color: #7dd3fc; }
    .data-status-bar { padding: 4px 8px; background: #1e293b; border-radius: 4px; margin-bottom: 6px; font-size: 0.75rem; color: #94a3b8; border: 1px solid #334155; }
    .data-status-bar strong { color: #e2e8f0; }
    .detail-tabs { display: flex; gap: 6px; margin-bottom: 6px; }
    .detail-tabs .tab-btn { padding: 6px 14px; font-size: 0.9rem; }
    .pagination { display: flex; align-items: center; gap: 8px; margin-top: 6px; font-size: 0.8rem; color: #94a3b8; }
    .pagination button { padding: 6px 12px; border-radius: 6px; border: 1px solid #334155; background: #1e293b; color: #94a3b8; cursor: pointer; }
    .pagination button:hover:not(:disabled) { background: #334155; color: #e2e8f0; }
    .pagination button:disabled { opacity: 0.5; cursor: not-allowed; }
    .filter-bar select { min-width: 120px; }
    .summary-row { cursor: pointer; }
    .sortable-th { cursor: pointer; user-select: none; }
    .sortable-th:hover { color: #38bdf8; }
    .sortable-th .sort-arrow { font-size: 0.7rem; margin-left: 2px; opacity: 0.6; }
    .summary-row:hover { background: #334155; }
    .expand-icon { display: inline-block; width: 18px; color: #38bdf8; font-size: 0.75rem; transition: transform 0.2s; }
    .summary-row.expanded .expand-icon { transform: rotate(90deg); }
    .detail-row td { padding-left: 24px; background: #0f172a; font-size: 0.75rem; color: #94a3b8; }
    .detail-row td:first-child { padding-left: 10px; }
    .btn-ai { display: flex; align-items: center; gap: 4px; padding: 6px 12px; border-radius: 6px; border: 1px solid #38bdf8; background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); color: #38bdf8; font-size: 0.85rem; font-weight: 600; cursor: pointer; }
    .btn-view-report { color: #38bdf8; text-decoration: none; font-size: 0.8rem; }
    .btn-view-report:hover { text-decoration: underline; }
    .btn-ai:hover { background: linear-gradient(135deg, #1e293b 0%, #334155 100%); color: #7dd3fc; border-color: #7dd3fc; }
    .btn-ai-icon { font-size: 1.1rem; }
    .insight-card { padding: 8px 10px; margin-bottom: 6px; border-radius: 6px; border-left: 4px solid #38bdf8; background: #1e293b; }
    .insight-card.warning { border-left-color: #fbbf24; }
    .insight-card.success { border-left-color: #34d399; }
    .insight-card .title { font-weight: 600; color: #e2e8f0; margin-bottom: 4px; }
    .insight-card .desc { font-size: 0.9rem; color: #94a3b8; margin-bottom: 4px; }
    .insight-card .action { font-size: 0.85rem; color: #38bdf8; }
    .sticky-top { position: sticky; top: 0; z-index: 10; background: #0f172a; padding-bottom: 2px; }
    .nav-row { display: flex; align-items: center; justify-content: space-between; gap: 12px; margin-bottom: 6px; padding: 4px 0; flex-wrap: wrap; }
    .nav-row .export-btns { display: flex; gap: 6px; margin-left: auto; }
    .nav-row .page-nav { display: flex; gap: 4px; margin: 0; padding: 0; border: none; }
    .page-nav .nav-tab { padding: 8px 18px; border-radius: 6px; border: 1px solid #334155; background: #1e293b; color: #94a3b8; cursor: pointer; font-size: 0.9rem; font-weight: 500; transition: all 0.2s; }
    .page-nav .nav-tab:hover { background: #334155; color: #e2e8f0; }
    .page-nav .nav-tab.active { background: #38bdf8; color: #0f172a; border-color: #38bdf8; }
    .page-panel { display: none; }
    .page-panel.active { display: block; }
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 1000; display: flex; align-items: center; justify-content: center; padding: 20px; }
    .modal-box { background: #1e293b; border-radius: 10px; border: 1px solid #334155; max-width: 90vw; max-height: 85vh; display: flex; flex-direction: column; overflow: hidden; }
    .modal-header { padding: 12px 16px; border-bottom: 1px solid #334155; display: flex; justify-content: space-between; align-items: center; }
    .modal-header h2 { font-size: 1rem; color: #e2e8f0; }
    .modal-close { background: none; border: none; color: #94a3b8; cursor: pointer; font-size: 1.2rem; padding: 0 8px; }
    .modal-close:hover { color: #f87171; }
    .modal-body { padding: 12px 16px; overflow-y: auto; flex: 1; }
    .modal-footer { padding: 12px 16px; border-top: 1px solid #334155; display: flex; justify-content: flex-end; gap: 8px; }
    .price-compare-group { margin-bottom: 16px; }
    .price-compare-group .cat-large { font-size: 0.95rem; font-weight: 600; color: #38bdf8; margin-bottom: 6px; }
    .price-compare-group .cat-mid { font-size: 0.85rem; color: #94a3b8; margin-left: 12px; margin-bottom: 4px; }
    .price-compare-group .cat-small { font-size: 0.8rem; color: #64748b; margin-left: 24px; margin-bottom: 2px; }
    .price-compare-group table { font-size: 0.78rem; margin-left: 32px; margin-bottom: 8px; }
    .section.scroll-table .table-wrap { max-height: 50vh; overflow-y: auto; }
    @media (max-width: 768px) { .kpi-row { grid-template-columns: 1fr 1fr; } .chart-row { grid-template-columns: 1fr; } .trend-section { grid-template-columns: 1fr; } .dashboard-grid { grid-template-columns: 1fr; } .filter-bar { flex-direction: column; align-items: stretch; } .nav-row { flex-direction: column; align-items: stretch; } }
  </style>
</head>
<body>
  <div class="sticky-top">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">
    <div>
      <h1>å¥½ç‰¹å–æ²ˆé˜³è¶…çº§ä»“è¿è¥çœ‹æ¿</h1>
      <p class="subtitle">ä¸´æœŸæŠ˜æ‰£é›¶å”® Â· æ•°æ®æ¥è‡ª MySQL htma_dashboard Â· <a href="/import" style="color:#38bdf8;">æ•°æ®å¯¼å…¥</a></p>
    </div>
    <div style="display:flex;gap:8px;">
      <button id="btnAiInsight" class="btn-ai" title="åŸºäºå½“å‰æ•°æ®ç”Ÿæˆæ™ºèƒ½åˆ†æå»ºè®®">
        <span class="btn-ai-icon">âœ¨</span> AI åˆ†æå»ºè®®
      </button>
      <button id="btnMarketingReport" class="btn-ai" title="ç”Ÿæˆè¿›é”€å­˜è¥é”€æŠ¥å‘Šå¹¶å‘é€ç»™ä½™ä¸ºå†›">
        <span class="btn-ai-icon">ğŸ“¤</span> ç”Ÿæˆè¥é”€æŠ¥å‘Š
      </button>
    </div>
  </div>

  <div class="filter-bar">
    <div class="period-tabs">
      <span class="tab-label">KPI å‘¨æœŸï¼š</span>
      <button class="tab-btn" data-period="custom" id="tabCustom">è‡ªå®šä¹‰</button>
      <button class="tab-btn" data-period="recent30">è¿‘30å¤©</button>
      <button class="tab-btn" data-period="month">æœ¬æœˆ</button>
      <button class="tab-btn" data-period="week">æœ¬å‘¨</button>
      <button class="tab-btn" data-period="day">ä»Šæ—¥</button>
    </div>
    <div class="date-range-inline" id="dateRangeInline" style="display:none;">
      <label>èµ·æ­¢æ—¥æœŸï¼š</label>
      <input type="date" id="startDate" />
      <span style="color:#64748b;">è‡³</span>
      <input type="date" id="endDate" />
    </div>
    <span class="filter-sep">|</span>
    <label>å¤§ç±»ï¼š</label>
    <select id="categoryLargeSelect">
      <option value="">å…¨éƒ¨å¤§ç±»</option>
    </select>
    <label>ä¸­ç±»ï¼š</label>
    <select id="categoryMidSelect">
      <option value="">å…¨éƒ¨ä¸­ç±»</option>
    </select>
    <label>å°ç±»ï¼š</label>
    <select id="categorySmallSelect">
      <option value="">å…¨éƒ¨å°ç±»</option>
    </select>
    <label>å•†å“ï¼š</label>
    <select id="productSelect">
      <option value="">å…¨éƒ¨å•†å“</option>
    </select>
    <button class="btn-query" id="btnQuery">æŸ¥è¯¢</button>
  </div>

  <div class="nav-row">
    <div class="page-nav">
      <button class="nav-tab active" data-page="overview">ğŸ“Š æ¦‚è§ˆ</button>
      <button class="nav-tab" data-page="category">ğŸ“ˆ å“ç±»æ’è¡Œ</button>
      <button class="nav-tab" data-page="detail">ğŸ“‹ é”€å”®æ˜ç»†</button>
      <button class="nav-tab" data-page="inventory">âš ï¸ åº“å­˜é¢„è­¦</button>
    </div>
    <div class="export-btns">
      <a class="btn-export" id="btnExportProduct" href="#" download="htma_å•†å“æ˜ç»†.csv">å¯¼å‡ºå•†å“</a>
      <a class="btn-export" id="btnExportCategory" href="#" download="htma_å“ç±»æ˜ç»†.csv">å¯¼å‡ºå“ç±»</a>
    </div>
  </div>
  </div>

  <div id="priceCompareModal" class="modal-overlay" style="display:none;">
    <div class="modal-box" style="width:720px;">
      <div class="modal-header">
        <h2>ğŸ“Š è´§ç›˜æ¯”ä»· - å¹³å°å•†å“ä¸ç«å“ä»·æ ¼å¯¹æ¯”</h2>
        <button class="modal-close" id="priceCompareModalClose">&times;</button>
      </div>
      <div class="modal-body">
        <p style="font-size:0.85rem;color:#94a3b8;margin-bottom:12px;">ä»¥ä¸‹ä¸ºå¹³å°å•†å“ï¼ˆæ¥è‡ª t_htma_platform_productsï¼‰ï¼ŒæŒ‰å¤§ç±»ã€ä¸­ç±»ã€å°ç±»åˆ†ç±»ï¼Œå«è§„æ ¼ã€æ¡ç ã€‚ç¡®è®¤åå°†å¯¹æ ‡äº¬ä¸œ/æ‹¼å¤šå¤šç­‰å¹³å°æ‰§è¡Œæ¯”ä»·ï¼ˆçº¦1-3åˆ†é’Ÿï¼‰ã€‚</p>
        <div id="priceCompareProductList"></div>
      </div>
      <div class="modal-footer">
        <button class="tab-btn" id="priceCompareModalCancel">å–æ¶ˆ</button>
        <button class="btn-query" id="priceCompareExecute">ç¡®è®¤æ‰§è¡Œæ¯”ä»·</button>
      </div>
    </div>
  </div>

  <div id="aiInsightSection" style="display:none; margin-bottom:6px;">
    <div class="section">
      <h2>ğŸ“Š è´§ç›˜æ¯”ä»·ï¼ˆå¹³å°å•†å“ vs äº¬ä¸œ/æ‹¼å¤šå¤šï¼‰</h2>
      <p style="font-size:0.8rem;color:#94a3b8;margin-bottom:8px;">åˆ—å‡ºå¹³å°å•†å“ï¼ˆæŒ‰å¤§ç±»/ä¸­ç±»/å°ç±»ã€è§„æ ¼ã€æ¡ç ï¼‰ï¼Œç¡®è®¤åæ‰§è¡Œç«å“æ¯”ä»·ï¼ˆçº¦1-3åˆ†é’Ÿï¼‰ã€‚</p>
      <button id="btnPriceCompare" class="btn-ai" title="æ‰“å¼€å•†å“åˆ—è¡¨ï¼Œç¡®è®¤åæ‰§è¡Œæ¯”ä»·">
        <span class="btn-ai-icon">ğŸ“Š</span> æ¯”ä»·
      </button>
    </div>
    <div class="section" style="margin-top:8px;">
      <h2>âœ¨ AI æ™ºèƒ½åˆ†æå»ºè®®</h2>
      <div id="aiInsightContent"></div>
    </div>
    <div class="section" style="margin-top:8px;">
      <h2>ğŸ“¤ è¥é”€æŠ¥å‘Šï¼ˆå‘é€ç»™ä½™ä¸ºå†›ï¼Œç»“æœå·²å­˜ MySQLï¼‰</h2>
      <div style="margin-bottom:8px;">
        <button id="btnGenReport" class="btn-query" style="padding:6px 14px;">ç”Ÿæˆå¹¶å‘é€è¥é”€æŠ¥å‘Š</button>
      </div>
      <div id="reportHistoryWrap">
        <h3 style="font-size:0.85rem;color:#94a3b8;margin-bottom:4px;">å†å²æŠ¥å‘Š</h3>
        <div id="reportHistoryList" class="table-wrap" style="max-height:200px;overflow-y:auto;"></div>
        <div id="reportDetailWrap" style="display:none;margin-top:8px;padding:8px;background:#0f172a;border-radius:6px;white-space:pre-wrap;font-size:0.8rem;max-height:300px;overflow-y:auto;"></div>
      </div>
    </div>
    <div class="section" style="margin-top:8px;">
      <h2>ğŸ’¬ AI å¯¹è¯ï¼ˆå¯æ“ä½œæ´å¯Ÿï¼‰</h2>
      <p style="font-size:0.8rem;color:#94a3b8;margin-bottom:8px;">é’ˆå¯¹æŠ¥å‘Šæé—®ï¼Œè·å–å¯æ‰§è¡Œå»ºè®®ã€‚å¯é—®ï¼šé”€å”®çªç ´500ä¸‡è¥é”€æ€ä¹ˆåšï¼Ÿæ¯›åˆ©æé«˜åˆ°200ä¸‡è¦å“ªäº›åŠ¨ä½œï¼Ÿå“ªäº›è´§å“æ€§ä»·æ¯”é«˜ï¼Ÿè´Ÿæ¯›åˆ©æ€ä¹ˆè¯Šæ–­ï¼Ÿæ–­è´§ä¼˜å…ˆçº§ï¼Ÿç§»åŠ¨å¼‚ä¸šåˆä½œæ€ä¹ˆè½åœ°ï¼Ÿ</p>
      <div id="aiChatWrap" style="background:#0f172a;border-radius:8px;padding:8px;border:1px solid #334155;">
        <div id="aiChatMessages" style="max-height:180px;overflow-y:auto;min-height:60px;font-size:0.85rem;white-space:pre-wrap;margin-bottom:8px;"></div>
        <div style="display:flex;gap:8px;">
          <input type="text" id="aiChatInput" placeholder="è¾“å…¥æ‚¨çš„é—®é¢˜ï¼Œå¦‚ï¼šè´Ÿæ¯›åˆ©æ€ä¹ˆéªŒè¯ï¼Ÿ" style="flex:1;padding:8px 12px;border-radius:6px;border:1px solid #334155;background:#1e293b;color:#e2e8f0;font-size:0.9rem;" />
          <button id="btnAiChatSend" class="btn-query" style="padding:8px 16px;">å‘é€</button>
        </div>
      </div>
    </div>
  </div>

  <div class="page-panel active" id="pageOverview" data-page="overview">
  <div class="kpi-row" id="kpiRow">
    <div class="kpi-card"><div class="label">æ€»é”€å”®é¢</div><div class="value" id="kpiSale">-</div></div>
    <div class="kpi-card"><div class="label">æ€»æ¯›åˆ©</div><div class="value" id="kpiProfit">-</div></div>
    <div class="kpi-card"><div class="label">å¹³å‡æ¯›åˆ©ç‡</div><div class="value" id="kpiRate">-</div></div>
    <div class="kpi-card"><div class="label">åº“å­˜æ€»é¢</div><div class="value" id="kpiStock">-</div></div>
  </div>

  <div class="trend-section" id="trendSection">
    <div class="trend-card">
      <h3>ç¯æ¯”åˆ†æï¼ˆæœ¬æœŸ vs ä¸ŠæœŸï¼‰</h3>
      <div id="popContent">åŠ è½½ä¸­...</div>
    </div>
    <div class="trend-card">
      <h3>èµ°åŠ¿ä¸åŒæ¯”</h3>
      <div id="yoyContent">åŠ è½½ä¸­...</div>
    </div>
    <div class="trend-card">
      <h3>å‘¨å‡ å¯¹æ¯”ï¼ˆå‘¨ä¸€ vs å‘¨äº”ç­‰ï¼‰</h3>
      <div id="dowChart" class="chart" style="height:180px;"></div>
    </div>
  </div>

  <div class="chart-row">
    <div class="chart-box chart-box-trend">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
        <h3 style="margin:0;">å“ç±»é”€å”®é¢å æ¯”</h3>
        <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:0.85rem;color:#94a3b8;">
          <input type="checkbox" id="pieShowData" />
          <span>æ˜¾ç¤ºå…·ä½“æ•°æ®</span>
        </label>
      </div>
      <div id="pieChart" class="chart"></div>
    </div>
    <div class="chart-box chart-box-trend">
      <h3>é”€å”®ä¸æ¯›åˆ©è¶‹åŠ¿</h3>
      <div class="chart-tabs">
        <button class="tab-btn active" data-granularity="day">æŒ‰æ—¥</button>
        <button class="tab-btn" data-granularity="week">æŒ‰å‘¨</button>
        <button class="tab-btn" data-granularity="month">æŒ‰æœˆ</button>
      </div>
      <div id="barChart" class="chart"></div>
    </div>
  </div>
  </div>

  <div class="page-panel" id="pageCategory" data-page="category">
  <div class="section scroll-table">
    <h2>å“ç±»æ’è¡Œï¼ˆæŒ‰å¤§ç±»å±•ç¤ºï¼Œç‚¹å‡»è¡Œå±•å¼€ä¸­ç±»/å°ç±»ï¼›ç‚¹å‡»åˆ—æ ‡é¢˜å¯é‡æ’ï¼‰</h2>
    <div class="table-wrap">
    <table id="categoryRankTable">
      <thead><tr>
        <th style="width:28px;"></th><th>æ’å</th><th>å¤§ç±»åç§°</th>
        <th class="num sortable-th" data-sort="sale_amount">é”€å”®é¢ <span class="sort-arrow">â†•</span></th>
        <th class="num sortable-th" data-sort="profit_amount">æ¯›åˆ© <span class="sort-arrow">â†•</span></th>
        <th class="num sortable-th" data-sort="margin_pct">æ¯›åˆ©ç‡ <span class="sort-arrow">â†•</span></th>
        <th class="num sortable-th" data-sort="sale_contrib_pct">é”€å”®è´¡çŒ® <span class="sort-arrow">â†•</span></th>
        <th class="num sortable-th" data-sort="profit_contrib_pct">æ¯›åˆ©è´¡çŒ® <span class="sort-arrow">â†•</span></th>
      </tr></thead>
      <tbody id="categoryRankBody"></tbody>
    </table>
    <div id="categoryRankDetailWrap" style="display:none; margin-top:8px;">
      <h3 style="font-size:0.85rem;color:#94a3b8;margin-bottom:4px;" id="categoryRankDetailTitle">â€” ä¸­ç±»/å°ç±»æ˜ç»†</h3>
      <table><thead><tr><th>æ’å</th><th>ä¸­ç±»</th><th>å°ç±»/å“ç±»</th><th class="num">é”€å”®é¢</th><th class="num">æ¯›åˆ©</th><th class="num">æ¯›åˆ©ç‡</th></tr></thead>
      <tbody id="categoryRankDetailBody"></tbody></table>
    </div>
    </div>
  </div>
  </div>

  <div class="page-panel" id="pageDetail" data-page="detail">
  <div class="section scroll-table">
    <h2>é”€å”®ä¸æ¯›åˆ©æ˜ç»†</h2>
    <div class="detail-tabs" style="margin-bottom:6px;">
      <button class="tab-btn active" data-detail="category">æŒ‰å“ç±»</button>
      <button class="tab-btn" data-detail="product">æŒ‰å•†å“</button>
    </div>
    <div id="profitTableWrap" class="table-wrap">
      <table id="profitTable">
        <thead><tr>
          <th style="width:28px;"></th><th>æ—¥æœŸ</th>
          <th class="sortable-th" data-sort="category_large">å¤§ç±» <span class="sort-arrow">â†•</span></th>
          <th class="sortable-th" data-sort="category_mid">ä¸­ç±» <span class="sort-arrow">â†•</span></th>
          <th class="sortable-th" data-sort="category">å°ç±»/å“ç±» <span class="sort-arrow">â†•</span></th>
          <th class="num sortable-th" data-sort="total_sale">é”€å”®é¢ <span class="sort-arrow">â†•</span></th>
          <th class="num sortable-th" data-sort="total_profit">æ¯›åˆ© <span class="sort-arrow">â†•</span></th>
          <th class="num sortable-th" data-sort="profit_rate">æ¯›åˆ©ç‡ <span class="sort-arrow">â†•</span></th>
        </tr></thead>
        <tbody id="profitTableBody"></tbody>
      </table>
      <table id="productTable" style="display:none;">
        <thead><tr>
          <th style="width:28px;"></th><th>æ—¥æœŸ</th>
          <th class="sortable-th" data-sort="sku_code">å•†å“ç¼–ç  <span class="sort-arrow">â†•</span></th>
          <th class="sortable-th" data-sort="product_name">å“å <span class="sort-arrow">â†•</span></th>
          <th class="sortable-th" data-sort="category_large">å¤§ç±» <span class="sort-arrow">â†•</span></th>
          <th class="sortable-th" data-sort="category_mid">ä¸­ç±» <span class="sort-arrow">â†•</span></th>
          <th class="sortable-th" data-sort="category">å°ç±»/å“ç±» <span class="sort-arrow">â†•</span></th>
          <th class="num sortable-th" data-sort="sale_qty">é”€é‡ <span class="sort-arrow">â†•</span></th>
          <th class="num sortable-th" data-sort="sale_amount">é”€å”®é¢ <span class="sort-arrow">â†•</span></th>
          <th class="num sortable-th" data-sort="sale_cost">æˆæœ¬ <span class="sort-arrow">â†•</span></th>
          <th class="num sortable-th" data-sort="gross_profit">æ¯›åˆ© <span class="sort-arrow">â†•</span></th>
          <th class="num sortable-th" data-sort="profit_rate_pct">æ¯›åˆ©ç‡ <span class="sort-arrow">â†•</span></th>
        </tr></thead>
        <tbody id="productTableBody"></tbody>
      </table>
      <div id="productPagination" class="pagination" style="display:none;"></div>
    </div>
  </div>
  </div>

  <div class="page-panel" id="pageInventory" data-page="inventory">
  <div class="section scroll-table">
    <h2>ä½åº“å­˜é¢„è­¦ï¼ˆåº“å­˜&lt;50 çš„ SKUï¼‰</h2>
    <p style="margin-bottom:6px;color:#94a3b8;font-size:0.75rem;">å…± <strong id="alertCount" style="color:#f87171;">-</strong> ä¸ª SKU éœ€å…³æ³¨ Â· æŒ‰å¤§ç±»å±•ç¤ºï¼Œç‚¹å‡»å±•å¼€æŸ¥çœ‹æ˜ç»†</p>
    <div class="table-wrap">
    <table id="invCategoryTable">
      <thead><tr><th style="width:28px;"></th><th>å¤§ç±»åç§°</th><th class="num">ä½åº“å­˜SKUæ•°</th><th class="num">åº“å­˜é‡‘é¢</th></tr></thead>
      <tbody id="invCategoryBody"></tbody>
    </table>
    <div id="invDetailWrap" style="display:none; margin-top:8px;">
      <h3 style="font-size:0.85rem;color:#94a3b8;margin-bottom:4px;" id="invDetailTitle">â€” æ˜ç»†</h3>
      <table>
        <thead><tr><th>å•†å“ç¼–ç </th><th>å“å</th><th>å“ç±»</th><th class="num">åº“å­˜æ•°é‡</th><th class="num">åº“å­˜é‡‘é¢</th><th>åº“å­˜æ—¥æœŸ</th></tr></thead>
        <tbody id="invTableBody"></tbody>
      </table>
      <div id="invPagination" class="pagination" style="display:none;"></div>
    </div>
    </div>
  </div>
  </div>

  <script>
    // åŒæºä¼˜å…ˆï¼›è‹¥åœ¨ Cursor é¢„è§ˆ/iframe ç­‰ç¯å¢ƒï¼Œå›é€€åˆ°æœ¬åœ° API
    const API = (function(){
      const o = window.location.origin;
      if (o && (o.includes('127.0.0.1') || o.includes('localhost'))) return o;
      return 'http://127.0.0.1:5002';
    })();
    let currentPeriod = 'recent30';
    let currentGranularity = 'day';
    let currentStartDate = '';
    let currentEndDate = '';
    let currentCategoryLargeCode = '';
    let currentCategoryMidCode = '';
    let currentCategorySmallCode = '';
    let currentSkuCode = '';
    let currentDetailPage = { category: 1, product: 1 };
    let currentInvPage = 1;
    const PAGE_SIZE = 50;

    function queryParams(overrides) {
      const p = new URLSearchParams();
      if (currentStartDate && currentEndDate) {
        p.set('start_date', currentStartDate);
        p.set('end_date', currentEndDate);
      } else {
        p.set('period', currentPeriod);
      }
      if (currentCategoryLargeCode) p.set('category_large_code', currentCategoryLargeCode);
      if (currentCategoryMidCode) p.set('category_mid_code', currentCategoryMidCode);
      if (currentCategorySmallCode) p.set('category_small_code', currentCategorySmallCode);
      if (currentSkuCode) p.set('sku_code', currentSkuCode);
      if (overrides) { for (const [k, v] of Object.entries(overrides)) { if (v != null) p.set(k, String(v)); } }
      return p.toString();
    }

    function updateExportLinks() {
      const base = API || window.location.origin || '';
      if (!base) return;
      const q = queryParams();
      const productEl = document.getElementById('btnExportProduct');
      const categoryEl = document.getElementById('btnExportCategory');
      if (productEl) productEl.href = base + '/api/export?export_type=product&' + q;
      if (categoryEl) categoryEl.href = base + '/api/export?export_type=category&' + q;
    }

    function fmtNum(v) { return v >= 10000 ? (v/10000).toFixed(1) + 'ä¸‡' : Number(v).toLocaleString(); }
    function fmtMoney(v) { return Number(v).toLocaleString('zh-CN', { minimumFractionDigits: 2 }); }

    async function loadKpi() {
      try {
        const r = await fetch(API + '/api/kpi?' + queryParams());
        const d = await r.json();
        document.getElementById('kpiSale').textContent = fmtNum(d.total_sale_amount);
        document.getElementById('kpiProfit').textContent = fmtNum(d.total_gross_profit);
        const rateEl = document.getElementById('kpiRate');
        rateEl.textContent = d.avg_profit_rate_pct + '%';
        rateEl.className = 'value' + (d.avg_profit_rate_pct >= 35 ? '' : d.avg_profit_rate_pct >= 20 ? ' warn' : ' danger');
        document.getElementById('kpiStock').textContent = fmtNum(d.total_stock_amount);
      } catch (e) { document.getElementById('kpiRow').innerHTML = '<div class="error">KPI åŠ è½½å¤±è´¥: ' + e.message + '</div>'; }
    }

    let pieChartInstance = null;
    let pieChartData = [];
    let categoryRankData = [];
    let categoryRankSort = { key: 'sale_amount', asc: false };
    let profitDetailData = [];
    let profitDetailSort = { key: 'total_sale', asc: false };
    let productDetailData = [];
    let productDetailSort = { key: 'sale_amount', asc: false };

    async function loadPie() {
      const el = document.getElementById('pieChart');
      const showData = document.getElementById('pieShowData');
      try {
        const r = await fetch(API + '/api/category_pie?' + queryParams());
        const data = await r.json();
        pieChartData = data.map(x => ({ name: String(x.category || ''), value: Number(x.sale_amount) || 0 }));
        pieChartInstance = echarts.init(el);
        const showLabels = showData && showData.checked;
        pieChartInstance.setOption(_pieOption(showLabels));
        if (showData) {
          showData.onchange = () => {
            if (pieChartInstance) pieChartInstance.setOption(_pieOption(showData.checked));
          };
        }
      } catch (e) { el.innerHTML = '<div class="loading">åŠ è½½å¤±è´¥: ' + e.message + '</div>'; }
    }

    function _pieOption(showData) {
      return {
        tooltip: { trigger: 'item', formatter: p => (p.name || '') + ': ' + (p.value != null ? Number(p.value).toLocaleString() : '') + (p.percent != null ? ' (' + p.percent.toFixed(1) + '%)' : '') },
        legend: { bottom: 0, left: 'center', textStyle: { color: '#94a3b8', fontSize: 11 }, type: 'scroll', itemGap: 8 },
        color: ['#38bdf8','#34d399','#fbbf24','#f87171','#a78bfa','#64748b','#22d3ee','#fb923c','#c084fc','#4ade80'],
        series: [{
          type: 'pie',
          radius: ['42%','72%'],
          center: ['50%','45%'],
          data: pieChartData,
          label: {
            show: true,
            position: 'outside',
            color: '#e2e8f0',
            fontSize: 11,
            formatter: function(p) {
              const name = p.name || '';
              if (!showData) return name;
              const v = p.value != null ? Number(p.value).toLocaleString() : '';
              const d = p.percent != null ? p.percent.toFixed(1) : '';
              return name + '\n' + v + ' (' + d + '%)';
            }
          },
          labelLine: { show: true, length: 10, length2: 12, lineStyle: { color: '#64748b' } },
          emphasis: { scale: true, itemStyle: { shadowBlur: 12, shadowOffsetX: 0 } }
        }]
      };
    }

    async function loadBar() {
      const el = document.getElementById('barChart');
      try {
        const r = await fetch(API + '/api/sales_trend?granularity=' + currentGranularity + '&' + queryParams());
        if (!r.ok) {
          const errText = await r.text();
          let errMsg = r.status + ' ' + r.statusText;
          try { const j = JSON.parse(errText); errMsg = j.error || j.message || errMsg; } catch (_) {}
          throw new Error(errMsg);
        }
        const data = await r.json();
        const chart = echarts.init(el);
        const xData = data.map(x => x.x_date);
        chart.setOption({
          tooltip: {
            trigger: 'axis',
            formatter: function(params) {
              const idx = params[0].dataIndex;
              const row = data[idx];
              return row.week_start ? row.x_date + ' (' + row.week_start + 'èµ·)<br/>é”€å”®é¢: ' + fmtMoney(row.sale_amount) + '<br/>æ¯›åˆ©: ' + fmtMoney(row.profit_amount)
                : row.x_date + '<br/>é”€å”®é¢: ' + fmtMoney(row.sale_amount) + '<br/>æ¯›åˆ©: ' + fmtMoney(row.profit_amount);
            }
          },
          legend: { data: ['é”€å”®é¢', 'æ¯›åˆ©'], bottom: 0, textStyle: { color: '#94a3b8' } },
          grid: { left: 55, right: 25, top: 45, bottom: 75 },
          xAxis: { type: 'category', data: xData, axisLabel: { color: '#94a3b8', rotate: 40, fontSize: 10, interval: 0 } },
          yAxis: { type: 'value', axisLabel: { color: '#94a3b8' }, splitLine: { lineStyle: { color: '#334155' } } },
          series: [
            { name: 'é”€å”®é¢', type: 'bar', data: data.map(x => x.sale_amount), itemStyle: { color: '#38bdf8' } },
            { name: 'æ¯›åˆ©', type: 'line', data: data.map(x => x.profit_amount), itemStyle: { color: '#34d399' }, lineStyle: { color: '#34d399' } }
          ]
        });
      } catch (e) { el.innerHTML = '<div class="loading">åŠ è½½å¤±è´¥: ' + e.message + '</div>'; }
    }

    function safeArray(data) {
      if (Array.isArray(data)) return data;
      if (data && Array.isArray(data.items)) return data.items;
      if (data && Array.isArray(data.data)) return data.data;
      return [];
    }

    async function loadProfitDetail() {
      const tbody = document.getElementById('profitTableBody');
      try {
        const r = await fetch(API + '/api/profit_summary?' + queryParams());
        if (!r.ok) throw new Error(r.status + ' ' + r.statusText);
        const data = await r.json();
        profitDetailData = safeArray(data);
        renderProfitDetail();
        bindProfitExpand();
        bindProfitDetailSort();
      } catch (e) { tbody.innerHTML = '<tr><td colspan="8" class="error">åŠ è½½å¤±è´¥: ' + e.message + '</td></tr>'; }
    }

    function renderProfitDetail() {
      const tbody = document.getElementById('profitTableBody');
      const key = profitDetailSort.key;
      const asc = profitDetailSort.asc;
      const sorted = [...profitDetailData].sort((a, b) => {
        const va = a[key];
        const vb = b[key];
        if (typeof va === 'number' && typeof vb === 'number') return asc ? va - vb : vb - va;
        const sa = String(va || '').localeCompare(String(vb || ''), 'zh-CN');
        return asc ? sa : -sa;
      });
      tbody.innerHTML = sorted.length === 0
        ? '<tr><td colspan="8" class="loading">æš‚æ— æ•°æ®</td></tr>'
        : sorted.map(row => {
            const cat = (row.category || '').replace(/"/g, '&quot;').replace(/</g, '&lt;');
            return `<tr class="summary-row" data-category="${cat}" data-expanded="0">
              <td><span class="expand-icon">â–¶</span></td>
              <td>â€”</td>
              <td>${(row.category_large || '').replace(/</g,'&lt;')}</td>
              <td>${(row.category_mid || '').replace(/</g,'&lt;')}</td>
              <td>${(row.category || '').replace(/</g,'&lt;')}</td>
              <td class="num">${fmtMoney(row.total_sale)}</td>
              <td class="num">${fmtMoney(row.total_profit)}</td>
              <td class="num">${(row.profit_rate != null ? row.profit_rate : 0).toFixed(2)}%</td>
            </tr>`;
          }).join('');
      bindProfitExpand();
    }

    function bindProfitDetailSort() {
      document.querySelectorAll('#profitTable .sortable-th').forEach(th => {
        th.onclick = (e) => {
          e.stopPropagation();
          const key = th.dataset.sort;
          if (!key) return;
          profitDetailSort.asc = profitDetailSort.key === key ? !profitDetailSort.asc : false;
          profitDetailSort.key = key;
          renderProfitDetail();
        };
      });
    }

    function bindProfitExpand() {
      document.querySelectorAll('#profitTableBody .summary-row').forEach(tr => {
        tr.onclick = async () => {
          const cat = tr.dataset.category;
          const expanded = tr.dataset.expanded === '1';
          if (expanded) {
            tr.classList.remove('expanded');
            tr.dataset.expanded = '0';
            tr.nextElementSibling?.remove();
            return;
          }
          try {
            const q = queryParams({ expand_category: cat });
            const r = await fetch(API + '/api/profit_detail?' + q + '&page_size=365');
            const d = await r.json();
            const items = d.items || [];
            const detailHtml = items.map(row => `<tr class="detail-row">
              <td></td>
              <td>${row.data_date}</td>
              <td>${(row.category_large || '').replace(/</g,'&lt;')}</td>
              <td>${(row.category_mid || '').replace(/</g,'&lt;')}</td>
              <td>${(row.category || '').replace(/</g,'&lt;')}</td>
              <td class="num">${fmtMoney(row.total_sale)}</td>
              <td class="num">${fmtMoney(row.total_profit)}</td>
              <td class="num">${(row.profit_rate != null ? row.profit_rate : 0).toFixed(2)}%</td>
            </tr>`).join('');
            const frag = document.createElement('tbody');
            frag.innerHTML = detailHtml;
          tr.classList.add('expanded');
          tr.dataset.expanded = '1';
          while (tr.nextElementSibling && tr.nextElementSibling.classList.contains('detail-row')) tr.nextElementSibling.remove();
          Array.from(frag.children).forEach(ch => tr.parentNode.insertBefore(ch, tr.nextSibling));
          } catch (err) { console.warn('å±•å¼€å¤±è´¥', err); }
        };
      });
    }

    async function loadProductDetail(page) {
      const tbody = document.getElementById('productTableBody');
      const pagEl = document.getElementById('productPagination');
      try {
        const q = queryParams({ page: page || currentDetailPage.product, page_size: PAGE_SIZE });
        const r = await fetch(API + '/api/sale_summary?' + q);
        if (!r.ok) throw new Error(r.status + ' ' + r.statusText);
        const d = await r.json();
        const rows = safeArray(d);
        productDetailData = rows;
        const total = d.total != null ? d.total : productDetailData.length;
        const curPage = d.page != null ? d.page : 1;
        currentDetailPage.product = curPage;
        renderProductDetail();
        renderPagination(pagEl, total, curPage, PAGE_SIZE, (p) => loadProductDetail(p));
        bindProductExpand();
        bindProductDetailSort();
      } catch (e) { tbody.innerHTML = '<tr><td colspan="12" class="error">åŠ è½½å¤±è´¥: ' + e.message + '</td></tr>'; pagEl.style.display = 'none'; }
    }

    function renderProductDetail() {
      const tbody = document.getElementById('productTableBody');
      const key = productDetailSort.key;
      const asc = productDetailSort.asc;
      const sorted = [...productDetailData].sort((a, b) => {
        const va = a[key];
        const vb = b[key];
        if (typeof va === 'number' && typeof vb === 'number') return asc ? va - vb : vb - va;
        const sa = String(va || '').localeCompare(String(vb || ''), 'zh-CN');
        return asc ? sa : -sa;
      });
      tbody.innerHTML = sorted.length === 0
        ? '<tr><td colspan="12" class="loading">æš‚æ— æ•°æ®</td></tr>'
        : sorted.map(row => {
            const sku = (row.sku_code || '').replace(/"/g, '&quot;').replace(/</g, '&lt;');
            return `<tr class="summary-row" data-sku="${sku}" data-expanded="0">
              <td><span class="expand-icon">â–¶</span></td>
              <td>â€”</td>
              <td>${(row.sku_code || '').replace(/</g,'&lt;')}</td>
              <td>${(row.product_name || '').replace(/</g,'&lt;').slice(0,20)}</td>
              <td>${(row.category_large || '').replace(/</g,'&lt;')}</td>
              <td>${(row.category_mid || '').replace(/</g,'&lt;')}</td>
              <td>${(row.category || '').replace(/</g,'&lt;')}</td>
              <td class="num">${row.sale_qty}</td>
              <td class="num">${fmtMoney(row.sale_amount)}</td>
              <td class="num">${fmtMoney(row.sale_cost)}</td>
              <td class="num">${fmtMoney(row.gross_profit)}</td>
              <td class="num">${(row.profit_rate_pct != null ? row.profit_rate_pct : 0).toFixed(2)}%</td>
            </tr>`;
          }).join('');
      bindProductExpand();
    }

    function bindProductDetailSort() {
      document.querySelectorAll('#productTable .sortable-th').forEach(th => {
        th.onclick = (e) => {
          e.stopPropagation();
          const key = th.dataset.sort;
          if (!key) return;
          productDetailSort.asc = productDetailSort.key === key ? !productDetailSort.asc : false;
          productDetailSort.key = key;
          renderProductDetail();
        };
      });
    }

    function bindProductExpand() {
      document.querySelectorAll('#productTableBody .summary-row').forEach(tr => {
        tr.onclick = async () => {
          const sku = tr.dataset.sku;
          const expanded = tr.dataset.expanded === '1';
          if (expanded) {
            tr.classList.remove('expanded');
            tr.dataset.expanded = '0';
            while (tr.nextElementSibling && tr.nextElementSibling.classList.contains('detail-row')) tr.nextElementSibling.remove();
            return;
          }
          try {
            const q = queryParams({ sku_code: sku });
            const r = await fetch(API + '/api/sale_detail?' + q + '&page_size=365');
            const d = await r.json();
            const items = d.items || [];
            const detailHtml = items.map(row => `<tr class="detail-row">
              <td></td>
              <td>${row.data_date}</td>
              <td>${(row.sku_code || '').replace(/</g,'&lt;')}</td>
              <td>${(row.product_name || '').replace(/</g,'&lt;').slice(0,20)}</td>
              <td>${(row.category_large || '').replace(/</g,'&lt;')}</td>
              <td>${(row.category_mid || '').replace(/</g,'&lt;')}</td>
              <td>${(row.category || '').replace(/</g,'&lt;')}</td>
              <td class="num">${row.sale_qty}</td>
              <td class="num">${fmtMoney(row.sale_amount)}</td>
              <td class="num">${fmtMoney(row.sale_cost)}</td>
              <td class="num">${fmtMoney(row.gross_profit)}</td>
              <td class="num">${(row.profit_rate_pct != null ? row.profit_rate_pct : 0).toFixed(2)}%</td>
            </tr>`).join('');
            const frag = document.createElement('tbody');
            frag.innerHTML = detailHtml;
            tr.classList.add('expanded');
            tr.dataset.expanded = '1';
            while (tr.nextElementSibling && tr.nextElementSibling.classList.contains('detail-row')) tr.nextElementSibling.remove();
            Array.from(frag.children).forEach(ch => tr.parentNode.insertBefore(ch, tr.nextSibling));
          } catch (err) { console.warn('å±•å¼€å¤±è´¥', err); }
        };
      });
    }

    function renderPagination(el, total, page, pageSize, onPage) {
      if (!el || total <= pageSize) { el.style.display = 'none'; return; }
      el.style.display = 'flex';
      const totalPages = Math.ceil(total / pageSize);
      const prevBtn = document.createElement('button');
      prevBtn.textContent = 'ä¸Šä¸€é¡µ';
      prevBtn.disabled = page <= 1;
      prevBtn.onclick = () => { if (page > 1) onPage(page - 1); };
      const nextBtn = document.createElement('button');
      nextBtn.textContent = 'ä¸‹ä¸€é¡µ';
      nextBtn.disabled = page >= totalPages;
      nextBtn.onclick = () => { if (page < totalPages) onPage(page + 1); };
      el.innerHTML = '';
      el.appendChild(document.createTextNode('å…± ' + total + ' æ¡ '));
      el.appendChild(prevBtn);
      el.appendChild(document.createTextNode(' ç¬¬ ' + page + ' / ' + totalPages + ' é¡µ '));
      el.appendChild(nextBtn);
    }

    async function loadDataStatus() {
      const el = document.getElementById('dataStatusText');
      if (!el) return;
      try {
        const r = await fetch(API + '/api/data_status');
        const d = await r.json();
        const range = (d.min_date && d.max_date) ? `${d.min_date} ~ ${d.max_date}` : '-';
        el.innerHTML = `é”€å”® <strong>${d.sale_count || 0}</strong> æ¡ Â· åº“å­˜ <strong>${d.stock_count || 0}</strong> æ¡ Â· æ¯›åˆ© <strong>${d.profit_count || 0}</strong> æ¡ Â· æ—¥æœŸèŒƒå›´ <strong>${range}</strong>`;
      } catch (e) { el.textContent = 'æ•°æ®çŠ¶æ€åŠ è½½å¤±è´¥'; }
    }

    async function loadProducts() {
      try {
        const q = new URLSearchParams();
        if (currentCategoryLargeCode) q.set('category_large_code', currentCategoryLargeCode);
        if (currentCategoryMidCode) q.set('category_mid_code', currentCategoryMidCode);
        if (currentCategorySmallCode) q.set('category_small_code', currentCategorySmallCode);
        const url = API + '/api/products' + (q.toString() ? '?' + q : '');
        const r = await fetch(url);
        const list = await r.json();
        const sel = document.getElementById('productSelect');
        sel.innerHTML = '<option value="">å…¨éƒ¨å•†å“</option>' + list.map(p =>
          `<option value="${p.sku_code}">${p.sku_code} (${p.category})</option>`
        ).join('');
        if (currentSkuCode) sel.value = currentSkuCode;
      } catch (e) { console.warn('å•†å“åŠ è½½å¤±è´¥', e); }
    }

    async function loadCategoryRank() {
      const tbody = document.getElementById('categoryRankBody');
      const wrap = document.getElementById('categoryRankDetailWrap');
      wrap.style.display = 'none';
      try {
        const r = await fetch(API + '/api/category_rank_by_large?' + queryParams());
        if (!r.ok) throw new Error(r.status + ' ' + r.statusText);
        const data = await r.json();
        categoryRankData = safeArray(data);
        renderCategoryRank();
        bindCategoryRankExpand();
        bindCategoryRankSort();
      } catch (e) { tbody.innerHTML = '<tr><td colspan="8" class="error">åŠ è½½å¤±è´¥: ' + e.message + '</td></tr>'; }
    }

    function renderCategoryRank() {
      const tbody = document.getElementById('categoryRankBody');
      const key = categoryRankSort.key;
      const asc = categoryRankSort.asc;
      const sorted = [...categoryRankData].sort((a, b) => {
        const va = a[key] != null ? Number(a[key]) : 0;
        const vb = b[key] != null ? Number(b[key]) : 0;
        return asc ? va - vb : vb - va;
      });
      tbody.innerHTML = sorted.length === 0
        ? '<tr><td colspan="8" class="loading">æš‚æ— æ•°æ®</td></tr>'
        : sorted.map((row, i) => {
            const code = (row.category_large_code || row.category_large || '').replace(/"/g, '&quot;');
            const name = (row.category_large || 'æœªåˆ†ç±»').replace(/</g, '&lt;');
            return `<tr class="summary-row cat-rank-row" data-expanded="0" data-large-code="${code}" data-large-name="${name}">
              <td><span class="expand-icon">â–¶</span></td>
              <td>${i + 1}</td>
              <td>${name}</td>
              <td class="num">${fmtMoney(row.sale_amount)}</td>
              <td class="num">${fmtMoney(row.profit_amount)}</td>
              <td class="num">${(row.margin_pct != null ? row.margin_pct : 0).toFixed(2)}%</td>
              <td class="num">${(row.sale_contrib_pct != null ? row.sale_contrib_pct : 0).toFixed(2)}%</td>
              <td class="num">${(row.profit_contrib_pct != null ? row.profit_contrib_pct : 0).toFixed(2)}%</td>
            </tr>`;
          }).join('');
    }

    function bindCategoryRankSort() {
      document.querySelectorAll('#categoryRankTable .sortable-th').forEach(th => {
        th.onclick = (e) => {
          e.stopPropagation();
          const key = th.dataset.sort;
          if (!key) return;
          categoryRankSort.asc = categoryRankSort.key === key ? !categoryRankSort.asc : false;
          categoryRankSort.key = key;
          renderCategoryRank();
          bindCategoryRankExpand();
        };
      });
    }

    function bindCategoryRankExpand() {
      const table = document.getElementById('categoryRankTable');
      if (!table) return;
      table.onclick = async (e) => {
        const tr = e.target.closest('.cat-rank-row');
        if (!tr) return;
        if (e.target.closest('.sortable-th')) return;
        e.preventDefault();
        e.stopPropagation();
        const expanded = tr.dataset.expanded === '1';
        const code = (tr.dataset.largeCode || '').trim();
        const name = (tr.dataset.largeName || '').trim();
        const wrap = document.getElementById('categoryRankDetailWrap');
        const titleEl = document.getElementById('categoryRankDetailTitle');
        const detailBody = document.getElementById('categoryRankDetailBody');
        if (expanded) {
          tr.classList.remove('expanded');
          tr.dataset.expanded = '0';
          wrap.style.display = 'none';
          return;
        }
        document.querySelectorAll('#categoryRankBody .cat-rank-row').forEach(r => { r.classList.remove('expanded'); r.dataset.expanded = '0'; });
        tr.classList.add('expanded');
        tr.dataset.expanded = '1';
        wrap.style.display = 'block';
        titleEl.textContent = (name || 'æœªåˆ†ç±»') + ' â€” ä¸­ç±»/å°ç±»æ˜ç»†';
        detailBody.innerHTML = '<tr><td colspan="6" class="loading">åŠ è½½ä¸­...</td></tr>';
        const key = code || name;
        if (!key) { detailBody.innerHTML = '<tr><td colspan="6" class="loading">æ— æ³•å±•å¼€</td></tr>'; return; }
        try {
          const base = queryParams();
          const q = (base ? base + '&' : '') + 'category_large_code=' + encodeURIComponent(key);
          const r = await fetch(API + '/api/category_rank_detail?' + q);
          if (!r.ok) throw new Error(r.status + ' ' + r.statusText);
          const rows = safeArray(await r.json());
          detailBody.innerHTML = rows.length === 0
            ? '<tr><td colspan="6" class="loading">æš‚æ— ä¸­ç±»/å°ç±»æ˜ç»†</td></tr>'
            : rows.map(row => `<tr>
              <td>${row.rank}</td>
              <td>${(row.category_mid || '').replace(/</g,'&lt;')}</td>
              <td>${(row.category || 'æœªåˆ†ç±»').replace(/</g,'&lt;')}</td>
              <td class="num">${fmtMoney(row.sale_amount)}</td>
              <td class="num">${fmtMoney(row.profit_amount)}</td>
              <td class="num">${(row.margin_pct != null ? row.margin_pct : 0).toFixed(2)}%</td>
            </tr>`).join('');
        } catch (err) { detailBody.innerHTML = '<tr><td colspan="6" class="error">åŠ è½½å¤±è´¥: ' + (err.message || err) + '</td></tr>'; }
      };
    }

    async function loadInvAlert(page) {
      try {
        const q = queryParams({ page: page || currentInvPage, page_size: PAGE_SIZE });
        const [r1, r2] = await Promise.all([
          fetch(API + '/api/inv_alert?' + q),
          fetch(API + '/api/inv_alert_by_category?level=large&' + q)
        ]);
        const cnt = r1.ok ? ((await r1.json()).alert_sku_count || 0) : 0;
        const byLarge = r2.ok ? safeArray(await r2.json()) : [];
        document.getElementById('alertCount').textContent = cnt;
        const tbody = document.getElementById('invCategoryBody');
        tbody.innerHTML = (byLarge || []).length === 0
          ? '<tr><td colspan="4" class="loading">æš‚æ— ä½åº“å­˜é¢„è­¦</td></tr>'
          : (byLarge || []).map(row => {
              const name = (row.category_large || 'æœªåˆ†ç±»').replace(/"/g, '&quot;').replace(/</g, '&lt;');
              const code = (row.category_large_code || row.category_large || '').replace(/"/g, '&quot;');
              return `<tr class="summary-row inv-summary" data-expanded="0" data-large="${code}" data-large-name="${name}">
                <td><span class="expand-icon">â–¶</span></td>
                <td>${name}</td>
                <td class="num">${row.alert_sku_count}</td>
                <td class="num">${fmtMoney(row.stock_amount)}</td>
              </tr>`;
            }).join('');
        bindInvExpand();
      } catch (e) { document.getElementById('invCategoryBody').innerHTML = '<tr><td colspan="4" class="error">åŠ è½½å¤±è´¥</td></tr>'; }
    }

    function bindInvExpand() {
      document.querySelectorAll('#invCategoryBody .inv-summary').forEach(tr => {
        tr.onclick = async () => {
          const expanded = tr.dataset.expanded === '1';
          const largeCode = tr.dataset.large;
          const largeName = tr.dataset.largeName;
          const wrap = document.getElementById('invDetailWrap');
          const titleEl = document.getElementById('invDetailTitle');
          const tbody = document.getElementById('invTableBody');
          const pagEl = document.getElementById('invPagination');
          if (expanded) {
            tr.classList.remove('expanded');
            tr.dataset.expanded = '0';
            wrap.style.display = 'none';
            return;
          }
          document.querySelectorAll('#invCategoryBody .inv-summary').forEach(r => { r.classList.remove('expanded'); r.dataset.expanded = '0'; });
          tr.classList.add('expanded');
          tr.dataset.expanded = '1';
          wrap.style.display = 'block';
          titleEl.textContent = (largeName || 'æœªåˆ†ç±»') + ' â€” ä½åº“å­˜ SKU æ˜ç»†';
          tbody.innerHTML = '<tr><td colspan="6" class="loading">åŠ è½½ä¸­...</td></tr>';
          try {
            const q = queryParams({ category_large_code: largeCode, page: 1, page_size: PAGE_SIZE });
            const [r1, r2] = await Promise.all([
              fetch(API + '/api/inv_alert?' + q),
              fetch(API + '/api/inv_alert_list?' + q)
            ]);
            const d = await r2.json();
            const rows = d.items || [];
            const total = d.total != null ? d.total : rows.length;
            currentInvPage = 1;
            tbody.innerHTML = rows.length === 0
              ? '<tr><td colspan="6" class="loading">è¯¥å¤§ç±»ä¸‹æš‚æ— ä½åº“å­˜ SKU</td></tr>'
              : rows.map(row => `<tr>
                <td>${(row.sku_code || '').replace(/</g,'&lt;')}</td>
                <td>${(row.product_name || '').replace(/</g,'&lt;').slice(0,20)}</td>
                <td>${(row.category || '').replace(/</g,'&lt;')}</td>
                <td class="num">${row.stock_qty}</td>
                <td class="num">${fmtMoney(row.stock_amount)}</td>
                <td>${row.data_date}</td>
              </tr>`).join('');
            renderPagination(pagEl, total, 1, PAGE_SIZE, (p) => loadInvDetailPage(largeCode, p));
          } catch (err) { tbody.innerHTML = '<tr><td colspan="6" class="error">åŠ è½½å¤±è´¥</td></tr>'; }
        };
      });
    }

    async function loadInvDetailPage(largeCode, page) {
      const tbody = document.getElementById('invTableBody');
      const pagEl = document.getElementById('invPagination');
      try {
        const q = queryParams({ category_large_code: largeCode, page: page || 1, page_size: PAGE_SIZE });
        const r = await fetch(API + '/api/inv_alert_list?' + q);
        const d = await r.json();
        const rows = d.items || [];
        const total = d.total != null ? d.total : rows.length;
        currentInvPage = d.page != null ? d.page : 1;
        tbody.innerHTML = rows.length === 0
          ? '<tr><td colspan="6" class="loading">æš‚æ— æ•°æ®</td></tr>'
          : rows.map(row => `<tr>
            <td>${(row.sku_code || '').replace(/</g,'&lt;')}</td>
            <td>${(row.product_name || '').replace(/</g,'&lt;').slice(0,20)}</td>
            <td>${(row.category || '').replace(/</g,'&lt;')}</td>
            <td class="num">${row.stock_qty}</td>
            <td class="num">${fmtMoney(row.stock_amount)}</td>
            <td>${row.data_date}</td>
          </tr>`).join('');
        renderPagination(pagEl, total, currentInvPage, PAGE_SIZE, (p) => loadInvDetailPage(largeCode, p));
      } catch (e) { tbody.innerHTML = '<tr><td colspan="6" class="error">åŠ è½½å¤±è´¥</td></tr>'; }
    }

    async function loadDowChart() {
      const el = document.getElementById('dowChart');
      if (!el) return;
      try {
        const r = await fetch(API + '/api/dow_sales?' + queryParams());
        const data = await r.json();
        const chart = echarts.init(el);
        chart.setOption({
          tooltip: { trigger: 'axis', formatter: p => {
            const idx = p[0].dataIndex;
            const row = data[idx];
            return (row.dow_name || '') + '<br/>é”€å”®é¢: ' + fmtMoney(row.sale_amount) + '<br/>æ¯›åˆ©: ' + fmtMoney(row.profit_amount) + '<br/>å¤©æ•°: ' + (row.day_count || 0);
          }},
          grid: { left: 40, right: 20, top: 20, bottom: 30 },
          xAxis: { type: 'category', data: data.map(x => x.dow_name), axisLabel: { color: '#94a3b8', fontSize: 11 } },
          yAxis: { type: 'value', axisLabel: { color: '#94a3b8' }, splitLine: { lineStyle: { color: '#334155' } } },
          series: [{ name: 'é”€å”®é¢', type: 'bar', data: data.map(x => x.sale_amount), itemStyle: { color: '#38bdf8' } }]
        });
      } catch (e) { el.innerHTML = '<div class="loading" style="padding:20px;">åŠ è½½å¤±è´¥</div>'; }
    }

    async function loadTrendAnalysis() {
      const popEl = document.getElementById('popContent');
      const yoyEl = document.getElementById('yoyContent');
      try {
        const r = await fetch(API + '/api/trend_analysis?granularity=' + currentGranularity + '&' + queryParams());
        const d = await r.json();
        let popHtml = '';
        if (d.period_over_period) {
          const p = d.period_over_period;
          const saleCls = p.sale_change_pct >= 0 ? 'trend-up' : 'trend-down';
          const profitCls = p.profit_change_pct >= 0 ? 'trend-up' : 'trend-down';
          popHtml = `
            <div class="trend-item"><span>æœ¬æœŸ (${p.current_period})</span><span>é”€å”®é¢ ${fmtMoney(p.current_sale)}</span></div>
            <div class="trend-item"><span>ä¸ŠæœŸ (${p.prev_period})</span><span>é”€å”®é¢ ${fmtMoney(p.prev_sale)}</span></div>
            <div class="trend-item"><span>é”€å”®é¢ç¯æ¯”</span><span class="${saleCls}">${p.sale_change_pct >= 0 ? '+' : ''}${p.sale_change_pct}%</span></div>
            <div class="trend-item"><span>æ¯›åˆ©ç¯æ¯”</span><span class="${profitCls}">${p.profit_change_pct >= 0 ? '+' : ''}${p.profit_change_pct}%</span></div>
          `;
        } else {
          popHtml = '<div class="trend-item">æ•°æ®ä¸è¶³ï¼Œæ— æ³•è®¡ç®—ç¯æ¯”</div>';
        }
        popEl.innerHTML = popHtml;

        let yoyHtml = '';
        const trendCls = d.trend === 'up' ? 'trend-up' : d.trend === 'down' ? 'trend-down' : 'trend-neutral';
        const trendText = d.trend === 'up' ? 'â†‘ è¿‘æœŸå‘ˆä¸Šå‡è¶‹åŠ¿' : d.trend === 'down' ? 'â†“ è¿‘æœŸå‘ˆä¸‹é™è¶‹åŠ¿' : 'â†’ è¿‘æœŸè¾ƒä¸ºå¹³ç¨³';
        yoyHtml += `<div class="trend-item"><span>èµ°åŠ¿</span><span class="${trendCls}">${trendText}</span></div>`;
        if (d.year_over_year) {
          const y = d.year_over_year;
          const saleCls = y.sale_change_pct >= 0 ? 'trend-up' : 'trend-down';
          const profitCls = y.profit_change_pct >= 0 ? 'trend-up' : 'trend-down';
          yoyHtml += `
            <div class="trend-item"><span>é”€å”®é¢åŒæ¯” (vs ${y.same_period_last_year})</span><span class="${saleCls}">${y.sale_change_pct >= 0 ? '+' : ''}${y.sale_change_pct}%</span></div>
            <div class="trend-item"><span>æ¯›åˆ©åŒæ¯”</span><span class="${profitCls}">${y.profit_change_pct >= 0 ? '+' : ''}${y.profit_change_pct}%</span></div>
          `;
        } else {
          const reason = d.yoy_reason || 'åŒæ¯”éœ€è‡³å°‘12ä¸ªæœˆï¼ˆæœˆï¼‰/53å‘¨ï¼ˆå‘¨ï¼‰/366å¤©ï¼ˆæ—¥ï¼‰å†å²æ•°æ®';
          yoyHtml += '<div class="trend-item" title="' + reason + '">æ•°æ®ä¸è¶³ï¼Œæ— æ³•è®¡ç®—åŒæ¯”</div><div class="trend-item" style="font-size:0.75rem;color:#64748b;">' + reason + '</div>';
        }
        yoyEl.innerHTML = yoyHtml;
      } catch (e) {
        document.getElementById('popContent').innerHTML = '<div class="error">åŠ è½½å¤±è´¥</div>';
        document.getElementById('yoyContent').innerHTML = '<div class="error">åŠ è½½å¤±è´¥</div>';
      }
    }

    function refreshAll() {
      Promise.all([loadKpi(), loadPie(), loadBar(), loadCategoryRank(), loadProfitDetail(), loadTrendAnalysis(), loadDowChart()]);
    }

    async function loadAiInsight() {
      const btn = document.getElementById('btnAiInsight');
      const section = document.getElementById('aiInsightSection');
      const content = document.getElementById('aiInsightContent');
      if (!btn || !section || !content) return;
      btn.disabled = true;
      btn.innerHTML = '<span class="btn-ai-icon">â³</span> åˆ†æä¸­...';
      try {
        const r = await fetch(API + '/api/insights?' + queryParams());
        const d = await r.json();
        const insights = d.insights || [];
        section.style.display = insights.length ? 'block' : 'none';
        content.innerHTML = insights.length === 0
          ? '<p class="loading">æš‚æ— åˆ†æå»ºè®®ï¼Œè¯·å…ˆå¯¼å…¥æ•°æ®</p>'
          : insights.map(i => `<div class="insight-card ${i.type || 'info'}">
            <div class="title">${(i.title || '').replace(/</g,'&lt;')}</div>
            <div class="desc">${(i.desc || '').replace(/</g,'&lt;')}</div>
            <div class="action">${(i.action || '').replace(/</g,'&lt;')}</div>
          </div>`).join('');
        section.scrollIntoView({ behavior: 'smooth', block: 'start' });
      } catch (e) {
        content.innerHTML = '<p class="error">åŠ è½½å¤±è´¥: ' + (e.message || 'ç½‘ç»œé”™è¯¯') + 'ã€‚è¯·ç¡®è®¤æœåŠ¡å·²å¯åŠ¨ï¼ˆnpm run htma:runï¼‰</p>';
        section.style.display = 'block';
      }
      btn.disabled = false;
      btn.innerHTML = '<span class="btn-ai-icon">âœ¨</span> AI åˆ†æå»ºè®®';
    }

    async function loadReportHistory() {
      const listEl = document.getElementById('reportHistoryList');
      if (!listEl) return;
      try {
        const r = await fetch(API + '/api/report_history?limit=20');
        const data = await r.json();
        if (!r.ok) throw new Error(data?.error || 'åŠ è½½å¤±è´¥');
        const items = Array.isArray(data) ? data : (data?.items || []);
        listEl.innerHTML = items.length === 0
          ? '<p class="loading" style="padding:12px;color:#64748b;">æš‚æ— å†å²æŠ¥å‘Šï¼Œç‚¹å‡»ä¸Šæ–¹æŒ‰é’®ç”Ÿæˆ</p>'
          : '<table><thead><tr><th>æ—¥æœŸ</th><th>æ—¶é—´</th><th>æ¥æ”¶äºº</th><th>çŠ¶æ€</th><th></th></tr></thead><tbody>' +
            items.map(x => `<tr>
              <td>${x.report_date || '-'}</td>
              <td>${(x.report_time || '').slice(11,19)}</td>
              <td>${(x.feishu_at_user_name || '-').replace(/</g,'&lt;')}</td>
              <td>${x.send_status ? 'âœ“å·²å‘é€' : 'âœ—å¤±è´¥'}</td>
              <td><a href="#" class="btn-view-report" data-id="${x.id}">æŸ¥çœ‹</a></td>
            </tr>`).join('') + '</tbody></table>';
        listEl.querySelectorAll('.btn-view-report').forEach(a => {
          a.addEventListener('click', (e) => { e.preventDefault(); loadReportDetail(parseInt(a.dataset.id)); });
        });
      } catch (e) {
        listEl.innerHTML = '<p class="error" style="padding:12px;">åŠ è½½å¤±è´¥ï¼Œè¯·å…ˆæ‰§è¡Œ scripts/06_create_report_log.sql åˆ›å»ºè¡¨</p>';
      }
    }

    async function loadReportDetail(id) {
      const wrap = document.getElementById('reportDetailWrap');
      if (!wrap) return;
      try {
        const r = await fetch(API + '/api/report_history/' + id);
        const d = await r.json();
        wrap.style.display = 'block';
        wrap.textContent = d.report_content || 'æ— å†…å®¹';
      } catch (e) {
        wrap.textContent = 'åŠ è½½å¤±è´¥: ' + (e.message || '');
        wrap.style.display = 'block';
      }
    }

    async function genAndSendReport() {
      const btn = document.getElementById('btnGenReport');
      if (!btn) return;
      btn.disabled = true;
      btn.textContent = 'ç”Ÿæˆä¸­...';
      try {
        const r = await fetch(API + '/api/marketing_report?send=1');
        const d = await r.json();
        if (d.success) {
          btn.textContent = d.feishu_ok ? 'âœ“ å·²å‘é€å¹¶ä¿å­˜' : 'å·²ä¿å­˜ï¼ˆé£ä¹¦å‘é€å¤±è´¥ï¼‰';
          loadReportHistory();
          const detailWrap = document.getElementById('reportDetailWrap');
          if (detailWrap) { detailWrap.style.display = 'block'; detailWrap.textContent = d.report || ''; }
        } else {
          btn.textContent = 'ç”Ÿæˆå¤±è´¥';
          alert('ç”Ÿæˆå¤±è´¥: ' + (d.error || ''));
        }
      } catch (e) {
        btn.textContent = 'ç”Ÿæˆå¤±è´¥';
        alert('è¯·æ±‚å¤±è´¥: ' + (e.message || ''));
      }
      btn.disabled = false;
      setTimeout(() => { if (btn) btn.textContent = 'ç”Ÿæˆå¹¶å‘é€è¥é”€æŠ¥å‘Š'; }, 2000);
    }

    function showAiSection() {
      const section = document.getElementById('aiInsightSection');
      if (section) section.style.display = 'block';
    }

    async function sendAiChat(msg) {
      const input = document.getElementById('aiChatInput');
      const messages = document.getElementById('aiChatMessages');
      const btn = document.getElementById('btnAiChatSend');
      if (!msg || !messages) return;
      const txt = String(msg).trim();
      if (!txt) return;
      if (input) input.value = '';
      if (btn) btn.disabled = true;
      messages.innerHTML += '<div style="margin-bottom:8px;"><span style="color:#38bdf8;">æ‚¨ï¼š</span>' + txt.replace(/</g,'&lt;') + '</div>';
      messages.scrollTop = messages.scrollHeight;
      try {
        const r = await fetch(API + '/api/ai_chat?message=' + encodeURIComponent(txt));
        const ct = r.headers.get('content-type') || '';
        const text = await r.text();
        let d;
        try {
          d = ct.includes('json') ? JSON.parse(text) : (text.startsWith('{') ? JSON.parse(text) : { success: false, reply: 'æœåŠ¡è¿”å›å¼‚å¸¸(' + r.status + ')ï¼Œè¯·ç¡®è®¤è®¿é—® ' + API });
        } catch (_) {
          d = { success: false, reply: 'æœåŠ¡è¿”å›é JSONï¼Œè¯·ç¡®è®¤åç«¯å·²å¯åŠ¨ï¼ˆnpm run htma:runï¼‰' };
        }
        const reply = (d && d.success) ? (d.reply || '') : ('é”™è¯¯: ' + (d && d.reply ? d.reply : 'æœªçŸ¥'));
        messages.innerHTML += '<div style="margin-bottom:8px;padding:8px;background:#1e293b;border-radius:6px;border-left:3px solid #38bdf8;"><span style="color:#34d399;">AIï¼š</span>' + reply.replace(/</g,'&lt;').replace(/\n/g,'<br/>') + '</div>';
        messages.scrollTop = messages.scrollHeight;
      } catch (e) {
        messages.innerHTML += '<div style="color:#f87171;">è¯·æ±‚å¤±è´¥: ' + (e.message || '').replace(/</g,'&lt;') + '</div>';
      }
      if (btn) btn.disabled = false;
    }

    async function onPriceCompareClick() {
      const modal = document.getElementById('priceCompareModal');
      const listEl = document.getElementById('priceCompareProductList');
      if (!modal || !listEl) return;
      showAiSection();
      modal.style.display = 'flex';
      listEl.innerHTML = '<p class="loading" style="padding:24px;">åŠ è½½å•†å“åˆ—è¡¨...</p>';
      try {
        const r = await fetch(API + '/api/price_compare_products?days=30&limit=300');
        const d = await r.json();
        if (!d.success) throw new Error(d.error || 'åŠ è½½å¤±è´¥');
        const groups = d.groups || {};
        let html = '';
        for (const [large, midMap] of Object.entries(groups)) {
          html += '<div class="price-compare-group"><div class="cat-large">' + (large || 'æœªåˆ†ç±»').replace(/</g,'&lt;') + '</div>';
          for (const [mid, smallMap] of Object.entries(midMap)) {
            html += '<div class="cat-mid">' + (mid || 'æœªåˆ†ç±»').replace(/</g,'&lt;') + '</div>';
            for (const [small, items] of Object.entries(smallMap)) {
              html += '<div class="cat-small">' + (small || 'æœªåˆ†ç±»').replace(/</g,'&lt;') + '</div>';
              html += '<table><thead><tr><th>å“å</th><th>è§„æ ¼</th><th>æ¡ç </th><th>å”®ä»·</th><th>é”€é‡</th></tr></thead><tbody>';
              for (const it of items) {
                html += '<tr><td>' + (it.raw_name || '').replace(/</g,'&lt;').slice(0,20) + '</td><td>' + (it.spec || '-').replace(/</g,'&lt;') + '</td><td>' + (it.barcode || '-').replace(/</g,'&lt;') + '</td><td class="num">' + (it.unit_price || 0) + '</td><td class="num">' + (it.sale_qty || 0) + '</td></tr>';
              }
              html += '</tbody></table>';
            }
          }
          html += '</div>';
        }
        listEl.innerHTML = html || '<p class="loading" style="padding:24px;">æš‚æ— ç¬¦åˆæ¡ä»¶å•†å“</p>';
        listEl.innerHTML += '<p style="font-size:0.8rem;color:#64748b;margin-top:12px;">å…± ' + (d.total || 0) + ' ä¸ªå•†å“</p>';
      } catch (e) {
        listEl.innerHTML = '<p class="error">åŠ è½½å¤±è´¥: ' + (e.message || '').replace(/</g,'&lt;') + '</p>';
      }
    }

    function closePriceCompareModal() {
      const modal = document.getElementById('priceCompareModal');
      if (modal) modal.style.display = 'none';
    }

    async function executePriceCompare() {
      const btn = document.getElementById('priceCompareExecute');
      if (!btn) return;
      btn.disabled = true;
      btn.textContent = 'æ‰§è¡Œä¸­ï¼ˆçº¦1-3åˆ†é’Ÿï¼‰...';
      try {
        const r = await fetch(API + '/api/price_compare', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ days: 30 })
        });
        const d = await r.json();
        if (d.success) {
          closePriceCompareModal();
          showAiSection();
          const content = document.getElementById('aiInsightContent');
          if (content) {
            let html = '<div class="insight-card success"><div class="title">è´§ç›˜æ¯”ä»·æŠ¥å‘Š</div>';
            if (d.all_exclusive_hint || d.fetcher_error) {
              html += '<div class="section" style="background:#451a03;color:#fcd34d;padding:10px 12px;border-radius:8px;margin-bottom:10px;font-size:0.85rem;">';
              html += '<strong>å•†å“æ¯”è¾ƒç¯èŠ‚è¯´æ˜ï¼š</strong>å½“å‰æœªè·å–åˆ°ç«å“ä»·æ ¼ï¼ˆäº¬ä¸œ/æ·˜å®ï¼‰ï¼Œå…¨éƒ¨æ˜¾ç¤ºä¸ºã€Œç‹¬å®¶æ¬¾ã€ã€‚';
              if (d.fetcher_error) html += '<br/>æ¥å£é¢„æ£€ï¼š' + (d.fetcher_error || '').replace(/</g,'&lt;');
              html += '<br/>è¯·æ£€æŸ¥ .env ä¸­ ONEBOUND_KEY/ONEBOUND_SECRET æˆ– PDD_HOJINGKE_APIKEYï¼Œä»¥åŠä¸‡é‚¦/èš‚èšæ˜Ÿçƒæ§åˆ¶å°æ˜¯å¦å·²å¼€é€šå¯¹åº”æ¥å£ã€‚';
              html += '</div>';
            }
            // ç¡®ä¿ items å­˜åœ¨ä¸”ä¸ºæ•°ç»„
            const items = Array.isArray(d.items) ? d.items : [];
            if (items.length > 0) {
              html += '<p style="font-size:0.8rem;color:#94a3b8;margin-bottom:8px;">å¥½ç‰¹å–è¶…çº§ä»“å•†å“ vs äº¬ä¸œ/æ·˜å®ä»·æ ¼ï¼ˆå…± ' + items.length + ' æ¡ï¼Œå·²å®ä½“åŒ–ä¿å­˜ï¼‰</p>';
              html += '<div class="section scroll-table" style="margin-bottom:10px;"><div class="table-wrap" style="max-height:360px;overflow:auto;"><table><thead><tr><th>å“å</th><th>è§„æ ¼</th><th class="num">å¥½ç‰¹å–å”®ä»·</th><th class="num">äº¬ä¸œæœ€ä½</th><th class="num">æ·˜å®æœ€ä½</th><th class="num">ç«å“æœ€ä½</th><th>æ¥æº</th><th class="num">ä¼˜åŠ¿%</th></tr></thead><tbody>';
              for (const it of items) {
                const name = (it.raw_name || '').replace(/</g,'&lt;').slice(0,24);
                const spec = (it.spec || '-').replace(/</g,'&lt;').slice(0,12);
                const ht = it.unit_price != null ? Number(it.unit_price).toFixed(2) : '-';
                const jd = it.jd_min_price != null ? Number(it.jd_min_price).toFixed(2) : '-';
                const tb = it.taobao_min_price != null ? Number(it.taobao_min_price).toFixed(2) : '-';
                const comp = it.competitor_min != null ? Number(it.competitor_min).toFixed(2) : '-';
                const plat = (it.platform || '-').replace(/</g,'&lt;').slice(0,14);
                const adv = it.advantage_pct != null ? it.advantage_pct + '%' : '-';
                html += '<tr><td>' + name + '</td><td>' + spec + '</td><td class="num">' + ht + '</td><td class="num">' + jd + '</td><td class="num">' + tb + '</td><td class="num">' + comp + '</td><td>' + plat + '</td><td class="num">' + adv + '</td></tr>';
              }
              html += '</tbody></table></div></div>';
            } else {
              html += '<p style="font-size:0.8rem;color:#94a3b8;margin-bottom:8px;">æš‚æ— æ¯”ä»·æ•°æ®ï¼Œè¯·æ£€æŸ¥æ•°æ®æºæˆ–ç¨åé‡è¯•</p>';
            }
            html += '<div class="desc" style="white-space:pre-wrap;max-height:240px;overflow-y:auto;font-size:0.8rem;">' + (d.report || '').replace(/</g,'&lt;').replace(/\n/g,'<br/>') + '</div></div>';
            content.innerHTML = html;
          }
          document.getElementById('aiInsightSection').scrollIntoView({ behavior: 'smooth', block: 'start' });
        } else {
          alert('æ¯”ä»·å¤±è´¥: ' + (d.error || 'æœªçŸ¥é”™è¯¯'));
        }
      } catch (e) {
        alert('è¯·æ±‚å¤±è´¥: ' + (e.message || ''));
      }
      btn.disabled = false;
      btn.textContent = 'ç¡®è®¤æ‰§è¡Œæ¯”ä»·';
    }

    (function setupPriceCompareModal() {
      document.getElementById('priceCompareModalClose')?.addEventListener('click', closePriceCompareModal);
      document.getElementById('priceCompareModalCancel')?.addEventListener('click', closePriceCompareModal);
      document.getElementById('priceCompareExecute')?.addEventListener('click', executePriceCompare);
      document.getElementById('priceCompareModal')?.addEventListener('click', (e) => { if (e.target.id === 'priceCompareModal') closePriceCompareModal(); });
    })();

    async function onMarketingReportClick() {
      const btn = document.getElementById('btnMarketingReport');
      const listEl = document.getElementById('reportHistoryList');
      if (!btn) return;
      btn.disabled = true;
      btn.innerHTML = '<span class="btn-ai-icon">â³</span> ç”Ÿæˆä¸­...';
      showAiSection();
      if (listEl) listEl.innerHTML = '<p class="loading" style="padding:16px;">æ­£åœ¨ç”ŸæˆæŠ¥å‘Šå¹¶å‘é€ç»™ä½™ä¸ºå†›...</p>';
      document.getElementById('reportHistoryWrap')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
      try {
        const r = await fetch(API + '/api/marketing_report?send=1');
        const d = await r.json();
        if (d.success) {
          btn.innerHTML = '<span class="btn-ai-icon">âœ“</span> å·²å‘é€';
          const detailWrap = document.getElementById('reportDetailWrap');
          if (detailWrap) { detailWrap.style.display = 'block'; detailWrap.textContent = d.report || ''; }
          await loadReportHistory();
        } else {
          btn.innerHTML = '<span class="btn-ai-icon">âœ—</span> å¤±è´¥';
          if (listEl) listEl.innerHTML = '<p class="error" style="padding:12px;">ç”Ÿæˆå¤±è´¥: ' + (d.error || '').replace(/</g,'&lt;') + '</p>';
        }
      } catch (e) {
        btn.innerHTML = '<span class="btn-ai-icon">âœ—</span> å¤±è´¥';
        const msg = e.name === 'AbortError' ? 'è¯·æ±‚è¶…æ—¶' : ('ç½‘ç»œé”™è¯¯: ' + (e.message || '') + 'ã€‚è¯·ç¡®è®¤æœåŠ¡å·²å¯åŠ¨ï¼šnpm run htma:run');
        if (listEl) listEl.innerHTML = '<p class="error" style="padding:12px;">' + msg.replace(/</g,'&lt;') + '</p>';
      }
      btn.disabled = false;
      setTimeout(() => { if (btn) btn.innerHTML = '<span class="btn-ai-icon">ğŸ“¤</span> ç”Ÿæˆè¥é”€æŠ¥å‘Š'; }, 3000);
    }

    async function loadCategoryLarge() {
      try {
        const r = await fetch(API + '/api/categories?level=large');
        const list = await r.json();
        const sel = document.getElementById('categoryLargeSelect');
        sel.innerHTML = '<option value="">å…¨éƒ¨å¤§ç±»</option>' + (list || []).map(x => `<option value="${(x.code||'').replace(/"/g,'&quot;')}">${(x.name||x.code||'').replace(/</g,'&lt;')}</option>`).join('');
      } catch (e) { console.warn('å¤§ç±»åŠ è½½å¤±è´¥', e); }
    }
    async function loadCategoryMid() {
      try {
        const r = await fetch(API + '/api/categories?level=mid&category_large_code=' + encodeURIComponent(currentCategoryLargeCode || ''));
        const list = await r.json();
        const sel = document.getElementById('categoryMidSelect');
        sel.innerHTML = '<option value="">å…¨éƒ¨ä¸­ç±»</option>' + (list || []).map(x => `<option value="${(x.code||'').replace(/"/g,'&quot;')}">${(x.name||x.code||'').replace(/</g,'&lt;')}</option>`).join('');
      } catch (e) { console.warn('ä¸­ç±»åŠ è½½å¤±è´¥', e); }
    }
    async function loadCategorySmall() {
      try {
        const q = 'category_large_code=' + encodeURIComponent(currentCategoryLargeCode || '') + '&category_mid_code=' + encodeURIComponent(currentCategoryMidCode || '');
        const r = await fetch(API + '/api/categories?level=small&' + q);
        const list = await r.json();
        const sel = document.getElementById('categorySmallSelect');
        sel.innerHTML = '<option value="">å…¨éƒ¨å°ç±»</option>' + (list || []).map(x => `<option value="${(x.code||'').replace(/"/g,'&quot;')}">${(x.name||x.code||'').replace(/</g,'&lt;')}</option>`).join('');
      } catch (e) { console.warn('å°ç±»åŠ è½½å¤±è´¥', e); }
    }

    async function loadDateRange() {
      try {
        const r = await fetch(API + '/api/date_range');
        const d = await r.json();
        const startIn = document.getElementById('startDate');
        const endIn = document.getElementById('endDate');
        if (startIn && d.min_date) startIn.min = d.min_date;
        if (endIn && d.max_date) { endIn.max = d.max_date; endIn.min = d.min_date; if (startIn) startIn.max = d.max_date; }
      } catch (e) { console.warn('æ—¥æœŸèŒƒå›´åŠ è½½å¤±è´¥', e); }
    }

    function applyFilter() {
      const startIn = document.getElementById('startDate');
      const endIn = document.getElementById('endDate');
      currentStartDate = startIn.value || '';
      currentEndDate = endIn.value || '';
      currentCategoryLargeCode = document.getElementById('categoryLargeSelect').value || '';
      currentCategoryMidCode = document.getElementById('categoryMidSelect').value || '';
      currentCategorySmallCode = document.getElementById('categorySmallSelect').value || '';
      currentSkuCode = document.getElementById('productSelect').value || '';
      updateExportLinks();
      loadKpi();
      loadPie();
      loadBar();
      loadCategoryRank();
      currentDetailPage.category = 1;
      currentDetailPage.product = 1;
      loadProfitDetail();
      loadProductDetail(1);
      loadTrendAnalysis();
      loadDowChart();
      currentInvPage = 1;
      loadInvAlert(1);
    }

    function updatePeriodTabActive() {
        const isCustom = (currentStartDate && currentEndDate) || currentPeriod === 'custom';
        document.querySelectorAll('.period-tabs .tab-btn').forEach(b => {
          b.classList.toggle('active', (isCustom && b.dataset.period === 'custom') || (!currentStartDate && b.dataset.period === currentPeriod));
        });
        const dateEl = document.getElementById('dateRangeInline');
        if (dateEl) dateEl.style.display = isCustom ? 'flex' : 'none';
      }

    (async function() {
      await loadCategoryLarge();
      await loadCategoryMid();
      await loadCategorySmall();
      await loadProducts();
      await loadDateRange();
      loadDataStatus();
      updatePeriodTabActive();
      updateExportLinks();
      await Promise.all([loadKpi(), loadPie(), loadBar(), loadCategoryRank(), loadProfitDetail(), loadProductDetail(1), loadInvAlert(), loadTrendAnalysis(), loadDowChart()]);

      document.getElementById('btnQuery').addEventListener('click', () => { applyFilter(); updatePeriodTabActive(); });
      document.getElementById('btnAiInsight').addEventListener('click', loadAiInsight);
      document.getElementById('btnMarketingReport').addEventListener('click', onMarketingReportClick);
      document.getElementById('btnPriceCompare').addEventListener('click', onPriceCompareClick);
      document.getElementById('btnGenReport').addEventListener('click', genAndSendReport);
      const aiChatInput = document.getElementById('aiChatInput');
      const aiChatSend = document.getElementById('btnAiChatSend');
      if (aiChatInput && aiChatSend) {
        aiChatSend.addEventListener('click', () => sendAiChat(aiChatInput.value));
        aiChatInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') sendAiChat(aiChatInput.value); });
      }

      document.querySelectorAll('.page-nav .nav-tab').forEach(btn => {
        btn.addEventListener('click', () => {
          const page = btn.dataset.page;
          document.querySelectorAll('.page-nav .nav-tab').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          document.querySelectorAll('.page-panel').forEach(p => p.classList.remove('active'));
          const panel = document.querySelector('.page-panel[data-page="' + page + '"]');
          if (panel) panel.classList.add('active');
          if (page === 'overview' && typeof echarts !== 'undefined') {
            ['pieChart', 'barChart', 'dowChart'].forEach(id => {
              const el = document.getElementById(id);
              if (el) {
                const inst = echarts.getInstanceByDom(el);
                if (inst) setTimeout(() => inst.resize(), 50);
              }
            });
          }
        });
      });

      function onCategoryLargeChange() {
        currentCategoryLargeCode = document.getElementById('categoryLargeSelect').value || '';
        currentCategoryMidCode = '';
        currentCategorySmallCode = '';
        document.getElementById('categoryMidSelect').value = '';
        document.getElementById('categorySmallSelect').value = '';
        loadCategoryMid();
        loadCategorySmall();
        loadProducts();
        currentSkuCode = '';
        document.getElementById('productSelect').value = '';
      }
      function onCategoryMidChange() {
        currentCategoryMidCode = document.getElementById('categoryMidSelect').value || '';
        currentCategorySmallCode = '';
        document.getElementById('categorySmallSelect').value = '';
        loadCategorySmall();
        loadProducts();
        currentSkuCode = '';
        document.getElementById('productSelect').value = '';
      }
      function onCategorySmallChange() {
        currentCategorySmallCode = document.getElementById('categorySmallSelect').value || '';
        loadProducts();
        currentSkuCode = '';
        document.getElementById('productSelect').value = '';
      }
      document.getElementById('categoryLargeSelect').addEventListener('change', onCategoryLargeChange);
      document.getElementById('categoryMidSelect').addEventListener('change', onCategoryMidChange);
      document.getElementById('categorySmallSelect').addEventListener('change', onCategorySmallChange);

      document.querySelectorAll('.detail-tabs .tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.detail-tabs .tab-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          const isProduct = btn.dataset.detail === 'product';
          const profitTbl = document.getElementById('profitTable');
          const prodTbl = document.getElementById('productTable');
          const prodPag = document.getElementById('productPagination');
          profitTbl.style.display = isProduct ? 'none' : 'table';
          prodTbl.style.display = isProduct ? 'table' : 'none';
          if (prodPag) prodPag.style.display = (!isProduct || !prodPag.innerHTML) ? 'none' : 'flex';
        });
      });

      document.querySelectorAll('.period-tabs .tab-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
          if (btn.dataset.period === 'custom') {
            const r = await fetch(API + '/api/date_range');
            const d = await r.json();
            const today = new Date().toISOString().slice(0, 10);
            if (d.min_date && d.max_date) {
              document.getElementById('startDate').value = d.min_date;
              document.getElementById('endDate').value = today > d.max_date ? d.max_date : today;
              currentStartDate = d.min_date;
              currentEndDate = today > d.max_date ? d.max_date : today;
              currentPeriod = 'custom';
            }
          } else {
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';
            currentStartDate = '';
            currentEndDate = '';
            currentPeriod = btn.dataset.period;
          }
          updatePeriodTabActive();
          updateExportLinks();
          loadKpi();
          loadPie();
          loadBar();
          loadCategoryRank();
          loadProfitDetail();
          loadProductDetail(1);
          loadTrendAnalysis();
          loadDowChart();
          loadInvAlert(1);
        });
      });

      document.querySelectorAll('.chart-tabs .tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.chart-tabs .tab-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          currentGranularity = btn.dataset.granularity;
          loadBar();
          loadTrendAnalysis();
        });
      });
    })();
  </script>
</body>
</html>
