# 商品动态比价：百度 Skill + OpenClaw 结合 - 待办清单

## 一、当前状态

| 模块 | 状态 | 说明 |
|------|------|------|
| 4 阶段比价逻辑 | ✅ 已有 | price_compare.py |
| 聚合数据 fetcher | ✅ 已有 | 需 JUHE_PRICE_KEY（接口曾维护中） |
| 百度 API 商城 fetcher | ⚠️ 部分 | 用 BAIDU_APISTORE_KEY，极速数据自有 appkey |
| 百度 AK/SK 鉴权 | ❌ 未接入 | 已配置 .env，但 baidu_fetcher 未调用百度 API 网关 |
| 极速数据 商品条码（百度版） | ❌ 不适用 | 不返回价格，无法用于比价 |
| 结果缓存/持久化 | ⚠️ 表已建 | t_htma_price_compare 未写入 |
| 定时/动态执行 | ❌ 未实现 | 无 cron/OpenClaw 定时 |
| OpenClaw Skill | ⚠️ 文档有 | 需实际配置到 OpenClaw |

---

## 二、待完成工作

### 1. 真实比价数据源（已接入 OneBound）

**现状**：OneBound 万邦已接入，支持淘宝关键词搜索返回真实价格。

| 选项 | 状态 | 动作 |
|------|------|------|
| **OneBound 万邦** | ✅ 已接入 | 在 .env 配置 ONEBOUND_KEY、ONEBOUND_SECRET 即可 |
| 聚合数据 商品比价 | 曾维护中 | 确认是否恢复 → 申请 JUHE_PRICE_KEY 作为备选 |
| 极速数据 商品条码（百度） | 不返回 price | 仅能补全商品信息，不能比价 |
| TMAPI 等 | 可选 | 需商品 ID，需先关键词搜索再查价，可后续扩展 |

**建议**：优先使用 OneBound；配置 `fetch_limit=50` 可控制 API 调用成本。

**自主比价（免费）**：使用 Playwright 爬取京东搜索页，见 `scripts/htma_price_scrape_jd.py`、`docs/京东自主比价-OpenClaw.md`。先 `npm run htma:price_scrape:dry` 预览，再 `playwright install chromium` 后执行 `npm run htma:price_scrape`。

---

### 2. 百度 API 网关 + AK/SK 接入

**现状**：已配置 BAIDU_AK、BAIDU_SK，但 baidu_fetcher 未调用百度 API 网关。

**待做**：

1. 在 `baidu_fetcher.py` 中实现百度 API 网关鉴权（BCE 签名）
2. 调用已购买的极速数据 API（若购买的是百度云市场版）：
   - 地址示例：`https://jisuapibarcode2.api.bdymkt.com/barcode2/query`
   - 需按 [百度 API 网关文档](https://cloud.baidu.com/doc/APIGW/index.html) 做签名
3. 注意：商品条码 API 不返回价格，需找到返回价格的 API 再接入

**参考**：百度 API 网关鉴权 https://cloud.baidu.com/doc/Reference/s/Njwvz1wot

---

### 3. 结果持久化与缓存

**现状**：`t_htma_price_compare` 表已建，但 `run_full_pipeline` 未写入。

**待做**：

1. 在 `price_compare.py` 的 `run_full_pipeline` 末尾，将 `items` 写入 `t_htma_price_compare`
2. 实现缓存策略：
   - 若 24 小时内已有结果，可优先读缓存（可选）
   - 或每次全量重算，用于「动态」更新

---

### 4. 动态比价：定时执行

**目标**：每日/每周自动跑比价，产出动态报告。

**待做**：

1. **OpenClaw 定时任务**：在 OpenClaw 中配置 cron，例如每天 9:00：
   ```
   cd /Users/document/好特卖超级仓/数据分析 && npm run htma:price_compare
   ```

2. **或系统 crontab**：
   ```bash
   0 9 * * * cd /Users/document/好特卖超级仓/数据分析 && npm run htma:price_compare >> /tmp/htma_price_compare.log 2>&1
   ```

3. **可选**：新增 `scripts/openclaw_dynamic_price_compare.sh`，在比价后：
   - 写入 MySQL
   - 调用飞书 webhook 推送摘要
   - 与 `openclaw_send_marketing_report.sh` 类似

---

### 5. OpenClaw Skill 正式配置

**现状**：文档中有 Skill 示例，未实际接入 OpenClaw。

**待做**：

1. 在 OpenClaw 的 skills 配置中加入货盘比价 Skill，例如：
   ```yaml
   - name: htma-price-compare
     description: 执行货盘价格对比分析
     trigger: |
       当用户说「货盘分析」「价格对比」「动态比价」「性价比分析」时触发
     action: |
       cd /Users/document/好特卖超级仓/数据分析 && npm run htma:price_compare
   ```

2. 参考 [OpenClaw Skills 文档](https://openclaw.im/tools/skills) 确认格式与配置方式

---

### 6. 条码补全（可选增强）

**目标**：有条码时优先用条码检索，提高同款匹配率。

**待做**：

1. 在 `stage1_standardize` 的 SQL 中 SELECT `barcode`（若 t_htma_sale / t_htma_stock 有此字段）
2. 将 barcode 传入 fetcher：`fetcher(std_name, barcode=barcode)`
3. 在 baidu_fetcher 中，有条码时优先调用条码 API（即使不返回价格，也可用于商品信息补全）

---

### 7. 限流与重试

**目标**：避免触发第三方 API 限流。

**待做**：

1. 在 `stage3_calc_advantage` 中，每次调用 fetcher 后 `time.sleep(0.1)` 或类似间隔
2. 对单次请求失败做 1 次重试
3. 可选：批量模式下调小并发或串行调用

---

## 三、优先级建议

| 优先级 | 事项 | 依赖 |
|--------|------|------|
| P0 | 确认/接入真实比价 API（聚合数据或其它） | 无 |
| P1 | 结果写入 t_htma_price_compare | 无 |
| P1 | OpenClaw 定时任务配置 | 无 |
| P2 | 百度 API 网关 + AK/SK 鉴权（若有返回价格的 API） | 找到合适 API |
| P2 | OpenClaw Skill 正式配置 | OpenClaw 已安装 |
| P3 | 条码补全、限流重试 | 基础流程跑通后 |

---

## 四、验收标准

- [ ] 配置 JUHE_PRICE_KEY 或其它真实 API 后，比价报告中的竞品价为真实数据
- [ ] 每次执行后，结果写入 t_htma_price_compare
- [ ] OpenClaw 定时任务每日自动执行比价
- [ ] 通过 OpenClaw 说「货盘分析」可一键触发比价
- [ ] 可选：比价完成后自动推送飞书摘要
