# 货盘价格对比分析 - 4 阶段闭环

## 一、核心逻辑框架

整个分析体系的核心是「标准化自有数据→检索竞品价格→量化价格优势→输出货盘策略」。

### 阶段 1：自有数据标准化（OpenCLAW 逻辑）

- **数据导出**：从 t_htma_sale + t_htma_stock 导出 SKU、品名、售价、分类、销量
- **数据清洗**：过滤「特价」「促销」「包邮」等无关词；统一单位（克→g、毫升→ml）；去特殊符号
- **数据校验**：剔除无规格、售价异常、销量为 0 的无效商品

### 阶段 2：竞品价格检索（百度 Skill 占位）

- **当前**：使用模拟 fetcher 生成测试数据
- **接入百度 Skill 后**：以标准化商品名为检索词，批量调用 API 获取全网最低价
- **数据提取**：同款同规格优先；无同款时取相似度≥90% 的相似款；取最低价作为对比基准

### 阶段 3：价格对比与指标量化

- **价格优势率** = (百度最低价 - 好特卖售价) / 百度最低价 × 100%
- 正数：好特卖有价格优势；负数：价格劣势；空值：独家款

### 阶段 4：货盘分层与决策输出

| 分层       | 价格优势率   | 策略           |
|------------|--------------|----------------|
| 高优势款   | ≥20%         | 重点主推       |
| 中等优势款 | 5%~20%       | 维持现状       |
| 无优势款   | 0~5%         | 微调定价/组合  |
| 价格劣势款 | <0%          | 清库存/换供应商 |
| 独家款     | 无竞品       | 提升毛利/差异化主推 |

## 二、执行方式

### 1. OpenCLAW / 终端

```bash
cd /Users/document/好特卖超级仓/数据分析
npm run htma:price_compare
```

或直接执行：

```bash
bash scripts/openclaw_price_compare.sh
```

### 2. API

```bash
curl "http://127.0.0.1:5002/api/price_compare?days=30"
```

### 3. AI 对话

在看板 AI 对话中输入：**哪些货品性价比高？**、**价格与百度识货对比** 等，将自动执行 4 阶段分析并返回报告。

## 三、接入真实比价 API

### 方式一：环境变量配置（推荐）

1. 复制 `.env.example` 为 `.env`
2. 填入以下任一 key（**优先 OneBound**，聚合数据曾维护中）：

| 变量 | 说明 | 申请链接 |
|------|------|----------|
| `ONEBOUND_KEY` + `ONEBOUND_SECRET` | **OneBound 万邦**（京东/淘宝，约 0.02–0.09 元/次，控制台可能不稳定） | [OneBound 控制台](https://console.open.onebound.cn/console/) |
| `PDD_HOJINGKE_APIKEY` | **拼多多 蚂蚁星球**（免费，OneBound 不可用时的替代） | [蚂蚁星球开放 API](https://www.haojingke.com/open-api/pdd) |
| `JUHE_PRICE_KEY` | 聚合数据 商品比价（关键词搜索，申请前请确认已恢复） | [聚合数据-商品比价](https://www.juhe.cn/docs/api/id/137) |
| `BAIDU_APISTORE_KEY` | 百度 API 商城 商品条码/搜索 | [百度 API 商城](https://apis.baidu.com/) 搜索「商品条码」购买 |

3. 重启看板或执行 `npm run htma:price_compare`，将自动使用真实 API

**OneBound 4013「Key已超量」**：需在 [控制台](https://console.open.onebound.cn/console/) 开通「京东」或「淘宝」→「item_search」接口，并确保 Key 余额充足。默认 `ONEBOUND_PLATFORM=jd` 与京东对标。

### 方式二：自定义 fetcher

在 `htma_dashboard/price_compare.py` 中传入自定义 fetcher：

```python
def my_fetcher(std_name: str) -> dict | None:
    # 调用任意比价 API
    # 返回 {"min_price": float, "platform": str, "is_same_spec": bool}
    ...
result = run_full_pipeline(conn, fetcher=my_fetcher, use_mock_fetcher=False)
```

### 相关链接

| 用途 | 链接 |
|------|------|
| **OneBound 万邦**（推荐） | https://console.open.onebound.cn/console/ |
| 聚合数据 商品比价 申请 | https://www.juhe.cn/docs/api/id/137 |
| 聚合数据 注册/实名认证 | https://www.juhe.cn/register |
| 百度 API 商城 | https://apis.baidu.com/ |
| 百度智能云 AK/SK 获取 | https://console.bce.baidu.com/iam/#/iam/accesslist |
| 百度智能云 鉴权说明 | https://cloud.baidu.com/doc/Reference/s/Njwvz1wot |

### 成本与限流

- OneBound 约 0.02–0.09 元/次，默认每次商品调用间隔 0.12 秒限流
- 可通过 `fetch_limit` 控制真实 API 调用次数，仅对前 N 个商品（按销售额排序）比价，其余标为独家款：
  - API：`/api/price_compare?days=30&fetch_limit=50`
  - 环境变量：`PRICE_COMPARE_FETCH_LIMIT=50`

## 四、OpenClaw Skill 配置（可选）

```yaml
- name: htma-price-compare
  description: 执行货盘价格对比分析
  trigger: |
    当用户说「货盘分析」「价格对比」「性价比分析」「run price compare」时触发
  action: |
    cd /Users/document/好特卖超级仓/数据分析 && npm run htma:price_compare
```
