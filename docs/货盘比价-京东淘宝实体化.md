# 货盘比价 - 京东/淘宝双平台实体化

## 功能说明

基于好特卖超级仓现有商品表（`t_htma_sale` + `t_htma_stock`），在京东、淘宝上搜索相同商品价格，进行比对，并**实体化保存**到 `t_htma_price_compare`，便于了解货盘的实际价格优劣势，供未来决策参考。

## 检索逻辑

- **条码优先**：有 EAN-13 等条码时，优先用条码检索（精准匹配）
- **名称+规格为辅**：条码无结果或缺失时，用「品牌 + 品名 + 规格」关键词检索
- **双平台**：分别查京东、淘宝，取最低价作为竞品价，并分别保存 `jd_min_price`、`taobao_min_price`

## 数据来源

- **商品**：`t_htma_sale` 近 30 天动销、销售额>100 的商品
- **京东**：OneBound 京东 / 京东蚂蚁星球 / 蚂蚁星球三合一
- **淘宝**：OneBound 淘宝（蚂蚁星球无淘宝接口）

## 使用方式

### 1. 执行表结构迁移（首次）

```bash
mysql -h 127.0.0.1 -u root -p htma_dashboard < scripts/09_price_compare_jd_taobao.sql
```

若部分列已存在会报错，可忽略。

### 2. 执行比价并落库

- **看板**：http://127.0.0.1:5002/ → AI 分析建议 → 比价 → 确认执行
- **命令行**：`npm run htma:price_compare` 或 `bash scripts/openclaw_price_compare.sh`

### 3. 查询已保存结果

- **API**：`GET /api/price_compare_results?run_at=2026-02-18&tier=高优势款&limit=100`
- **看板**：比价执行完成后，结果表格会展示京东最低、淘宝最低、竞品最低、优势%

## 表结构（t_htma_price_compare 扩展列）

| 列名 | 说明 |
|------|------|
| raw_name | 原始品名 |
| spec | 规格 |
| barcode | 条码 |
| jd_min_price | 京东最低价 |
| jd_platform | 京东数据来源 |
| taobao_min_price | 淘宝最低价 |
| taobao_platform | 淘宝数据来源 |
| competitor_min | 竞品最低价（京东、淘宝取低） |
| advantage_pct | 价格优势率 % |
| tier | 高优势款/中等优势款/无优势款/价格劣势款/独家款 |

## 配置

需在 `.env` 中配置至少其一：

- `ONEBOUND_KEY` + `ONEBOUND_SECRET`：京东+淘宝（推荐）
- `PDD_HOJINGKE_APIKEY`：京东/拼多多 蚂蚁星球

## 京东无数据、淘宝有数据时的排查

- **OneBound 控制台**：登录 [万邦开放平台](https://console.open.onebound.cn/) → 确认已开通 **京东** `item_search` 接口（与淘宝是分开开通的）。
- **京东返回结构**：代码已兼容 `items` 为 list、以及 `price`/`promotion_price`/`jdPrice`/`wlPrice` 等多种字段；若仍无京东价，多为接口未开通或返回 `error_code` 非 0000。
- **超级仓商品名**：若品名过于笼统（如仅「浆果类」「烘焙」），京东/淘宝可能只匹配到类目商品，属数据源差异，非代码问题。

## 全部为「独家款」、竞品价均为 "-" 时的排查（AI 分析比价环节）

说明：**商品比较环节**会按「条码优先 → 名称+规格关键词」向京东/淘宝接口请求竞品价；若接口未配置或未返回数据，则全部标为「独家款」，竞品最低/来源/优势% 显示为 "-"。

1. **确认 .env 配置**：至少配置其一  
   - `ONEBOUND_KEY` + `ONEBOUND_SECRET`（万邦京东+淘宝）  
   - `PDD_HOJINGKE_APIKEY`（蚂蚁星球京东/拼多多）
2. **万邦**：登录 [万邦开放平台](https://console.open.onebound.cn/) 确认已开通 **京东**、**淘宝** 的 `item_search` 接口（用量/权限不足会返回错误，导致无数据）。
3. **蚂蚁星球**：在开发者中心完成京东联盟设置后，京东关键词搜索才会返回有效价格。
4. **看板提示**：执行比价后若全部为独家款，AI 分析区域会显示黄色说明框，提示检查上述配置。
