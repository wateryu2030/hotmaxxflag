# 商品比价自动化策略（Cursor + OpenClaw + Kimi）

## 一、目标与范围

- **数据规模**：超级仓约 3 万+ 商品，全量每日比价成本高，采用「按日销售动态筛选 + 有限条数比价」策略。
- **触发方式**：
  1. **用户主动触发**：看板「AI 分析建议 → 比价」或接口 `POST /api/price_compare`。
  2. **每日自动执行**：每晚对「当日（无数据则取昨日）销售占比高、销售额大」的商品做比价，结果通过飞书推送给指定用户。
- **角色分工**：
  - **Cursor**：调度与编排（执行脚本、配置 cron、规则与文档）。
  - **OpenClaw**：采集竞品平台价格（执行比价脚本、可扩展浏览器/爬虫）。
  - **Kimi**：智能匹配与比对（可选：结果摘要、关键词优化，需配置 KIMI_API_KEY）。

---

## 二、数据比对策略

### 2.1 筛选「当日需比价商品」

- **数据源**：`t_htma_sale`（按 `data_date` 单日汇总）。
- **日期选择**：优先当日；若当日无销售数据则用**昨日**（最近有销售的一天）。
- **排序与条数**：按当日 **销售额** 降序，取前 N 个（默认 50，可由 `PRICE_COMPARE_DAILY_LIMIT` 配置）。
- **实现**：`price_compare.stage1_standardize_single_day(conn, store_id, data_date, limit)`，供每日流水线调用。

### 2.2 竞品价格采集（OpenClaw）

- **来源**：京东、淘宝（OneBound / 蚂蚁星球等，见 `.env` 配置）。
- **逻辑**：条码优先；无条码或条码无结果时用「品牌+品名+规格」关键词检索。
- **执行**：现有 `price_compare.run_daily_top_compare` 内部调用 `baidu_fetcher`（OneBound/蚂蚁星球），可由 OpenClaw 定时执行同一脚本，实现「OpenClaw 采集竞品价格」。

### 2.3 智能匹配与比对（Kimi，可选）

- **可选能力**：对比价结果做简短摘要、或对商品名做关键词优化后再查竞品。
- **实现方式**：配置 `KIMI_API_KEY` 后，可在推送飞书前调用 Kimi 生成 200 字以内摘要附在报告中（当前为占位，可按需扩展）。

### 2.4 飞书推送

- **默认接收人**：余为军（open_id：`ou_8db735f2`，即 `8db735f2`）。
- **自定义接收人**：环境变量 `FEISHU_AT_USER_ID`（必填）、`FEISHU_AT_USER_NAME`（选填，用于 @ 展示）。
- **标题**：自动比价报告使用「好特卖商品比价报告」，与进销存报告区分。

---

## 三、实现与入口

### 3.1 每日自动比价脚本（推荐由 Cursor/OpenClaw/cron 调用）

```bash
cd /Users/document/好特卖超级仓/数据分析 && .venv/bin/python scripts/htma_nightly_price_compare.py
```

- **环境变量**：
  - `PRICE_COMPARE_DAILY_LIMIT`：当日 TOP 商品条数（默认 50）。
  - `PRICE_COMPARE_FETCH_LIMIT`：实际调用竞品 API 的条数（默认与 DAILY_LIMIT 一致）。
  - `FEISHU_AT_USER_ID`：飞书接收人 open_id（默认 `ou_8db735f2`）。
  - `FEISHU_AT_USER_NAME`：飞书 @ 显示名（默认「余为军」）。

### 3.2 用户主动触发

- **看板**：http://127.0.0.1:5002/ → AI 分析建议 → 比价 → 确认执行。
- **接口**：
  - 全量/近 N 天：`POST /api/price_compare`，body 可选 `days`、`fetch_limit`。
  - **每日 TOP 比价并可选推送飞书**：`POST /api/price_compare_daily`，body 可选 `limit`（默认 50）、`fetch_limit`、`send_feishu`（true 时推送）、`feishu_at_user_id`、`feishu_at_user_name`。

### 3.3 定时任务（每晚自动，无人值守）

- **cron 示例**（每天 22:00 执行）：

```cron
0 22 * * * cd /Users/document/好特卖超级仓/数据分析 && .venv/bin/python scripts/htma_nightly_price_compare.py >> /tmp/htma_price_compare.log 2>&1
```

- **OpenClaw 定时**：在 OpenClaw 中配置每日 22:00 执行上述命令，由 Cursor 编排说明写入规则或文档即可。

---

## 四、Cursor + OpenClaw + Kimi 分工小结

| 环节           | 负责方   | 说明 |
|----------------|----------|------|
| 销售数据筛选   | Cursor/脚本 | 单日 TOP 由 `stage1_standardize_single_day` + `run_daily_top_compare` 完成。 |
| 竞品价格采集   | OpenClaw | 执行比价脚本，内部通过 OneBound/蚂蚁星球等拉取京东、淘宝价格。 |
| 智能匹配/摘要  | Kimi     | 可选：配置 KIMI_API_KEY 后做结果摘要或关键词优化。 |
| 飞书推送       | 脚本     | `feishu_util.send_feishu`，接收人由 FEISHU_AT_USER_ID 指定（默认余为军 8db735f2）。 |
| 调度与无人值守 | Cursor   | 配置 cron / OpenClaw 定时任务，全程无需人工点击。 |

---

## 五、相关文件

- **策略与入口**：`docs/商品比价自动化策略.md`（本文档）。
- **单日筛选与每日流水线**：`htma_dashboard/price_compare.py`（`stage1_standardize_single_day`、`run_daily_top_compare`）。
- **每日脚本**：`scripts/htma_nightly_price_compare.py`。
- **飞书推送**：`htma_dashboard/feishu_util.py`（支持自定义 title、at_user_id）。
- **OpenClaw 一键执行**：`scripts/openclaw_nightly_price_compare.sh`（见下节）。

---

## 六、OpenClaw 一键执行（可选）

若希望通过 OpenClaw 说「执行每日比价」即可触发，可配置 Skill 或直接执行：

```bash
cd /Users/document/好特卖超级仓/数据分析 && .venv/bin/python scripts/htma_nightly_price_compare.py
```

已提供 `scripts/openclaw_nightly_price_compare.sh`，内容同上，便于 OpenClaw/cron 统一调用。
