# 好特卖进销存营销报告 - 定时推送飞书

## 一、功能说明

基于现有销售、库存、毛利数据，自动分析并生成营销建议报告，通过飞书定时推送。报告包含：

| 模块 | 说明 |
|------|------|
| **动销 Top10** | 销量领先商品，建议加大陈列、做堆头/端架 |
| **高毛利 Top10** | 毛利率≥35% 且销售额>500，建议重点推广 |
| **黄金商品** | 动销好+毛利高（销量≥10件 毛利率≥30%），建议主推 |
| **需补货** | 畅销但库存不足，建议优先补货 |
| **滞销高库存** | 库存≥100件 近30天销量<3件，建议促销清仓 |
| **品类毛利 Top5** | 聚焦头部品类做主题陈列 |

## 二、使用方式

### 1. 手动执行（测试）

```bash
cd /Users/document/好特卖超级仓/数据分析
source .venv/bin/activate
python scripts/htma_marketing_report.py
```

仅预览不发送飞书：
```bash
python scripts/htma_marketing_report.py --dry-run
```

### 2. 通过 API 触发（需看板已启动）

```bash
# 生成报告并发送飞书
curl "http://127.0.0.1:5002/api/marketing_report?send=1"

# 仅获取报告 JSON，不发送
curl "http://127.0.0.1:5002/api/marketing_report"
```

### 3. OpenClaw 定时任务

在 OpenClaw 中配置定时任务，例如每天 9:00 执行：

```
cd /Users/document/好特卖超级仓/数据分析 && bash scripts/openclaw_send_marketing_report.sh
```

或使用 OpenClaw Skill：

```yaml
- name: htma-marketing-report
  description: 生成进销存营销分析报告并推送飞书
  trigger: |
    当用户说「发送营销报告」「进销存分析」「好特卖营销建议」时触发
  action: |
    cd /Users/document/好特卖超级仓/数据分析 && bash scripts/openclaw_send_marketing_report.sh
```

### 4. 系统 Crontab 定时

每天上午 9 点发送：

```bash
crontab -e
# 添加：
0 9 * * * cd /Users/document/好特卖超级仓/数据分析 && .venv/bin/python scripts/htma_marketing_report.py >> /tmp/htma_report.log 2>&1
```

## 三、环境变量

| 变量 | 说明 | 默认 |
|------|------|------|
| `FEISHU_WEBHOOK_URL` | 飞书机器人 Webhook | 项目内置 |
| `MYSQL_HOST` | MySQL 主机 | 127.0.0.1 |
| `MYSQL_USER` | MySQL 用户 | root |
| `MYSQL_PASSWORD` | MySQL 密码 | 62102218 |

## 四、飞书配置

### 1. 机器人 Webhook

1. 在飞书群聊中添加「自定义机器人」
2. 获取 Webhook URL
3. 设置环境变量：`export FEISHU_WEBHOOK_URL="你的webhook地址"`

### 2. @ 指定人（如余为军）

要 @ 指定人并发送通知，需设置其 **open_id**：

```bash
export FEISHU_AT_USER_ID="ou_xxxxxxxx"   # 余为军的 open_id
export FEISHU_AT_USER_NAME="余为军"      # 可选，默认余为军
```

**获取 open_id 方式：**
- 飞书管理后台 → 工作台 → 通讯录 → 找到用户 → 用户详情中的 open_id
- 或使用飞书开放平台 API：`contact/v3/users/batch_get_id`，通过手机号/邮箱查询

未设置时，消息会以「【@余为军】」文本开头，但不会触发 @ 提醒。

## 五、npm 快捷命令

```bash
npm run htma:report        # 生成并发送报告
npm run htma:report:dry    # 仅预览不发送
```

（需在 package.json 中添加对应 script）
